<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ä¸‰å›½æ™ºéœ¸</title>
    <style>
        body { 
            font-family: 'SimSun', serif; 
            background: url('https://img.freepik.com/free-vector/chinese-pattern-background_53876-90035.jpg') center/cover fixed; 
            margin: 0;
            padding: 0;
        }
        .game-container { 
            display: grid; 
            grid-template-columns: 1fr 2fr 1fr; 
            gap: 20px; 
            padding: 20px; 
            max-width: 1400px; 
            margin: 0 auto; 
            background-color: rgba(255,255,255,0.85); 
            border-radius: 15px; 
            border: 3px solid #8B4513; 
        }
        .panel { 
            background-color: rgba(255,248,220,0.9); 
            border-radius: 10px; 
            padding: 15px;  /* å‡å°‘å†…è¾¹è· */
            border: 2px solid #8B4513; 
        }
        .city-node { 
            position: absolute; 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            background-color: #FFD700; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            border: 2px solid #8B0000; 
            font-size: 12px;
        }
        .city-node-owned { 
            background-color: #006400; 
            color: white; 
            border-color: #000; 
        }
        .action-button { 
            background-color: #8B4513; 
            color: white; 
            padding: 6px 12px;  /* å‡å°‘è¡Œå®½ */
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 3px 0;  /* å‡å°‘é—´è· */
            display: block;
            width: 100%;
            box-sizing: border-box;
            font-size: 0.85rem;  /* å‡å°å­—ä½“å¤§å° */
        }
        .character-selection { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.8); 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
            color: white;
        }
        .character-card { 
            background-color: rgba(255,248,220,0.95); 
            border-radius: 10px; 
            padding: 20px; 
            width: 250px; 
            text-align: center; 
            cursor: pointer; 
            border: 3px solid #8B4513; 
            transition: transform 0.3s; 
            color: black;
            margin: 10px;
        }
        .character-card:hover { 
            transform: scale(1.05); 
        }
        .character-card.disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
        }
        .cover-screen { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.9); 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            z-index: 2000; 
            color: white; 
        }
        .cover-title { 
            font-size: 4rem; 
            color: #FFD700; 
            text-shadow: 3px 3px 5px #8B0000; 
            margin-bottom: 30px; 
            animation: pulse 2s infinite; 
        }
        .start-button { 
            background-color: #8B0000; 
            color: white; 
            padding: 15px 40px; 
            font-size: 1.5rem; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            transition: all 0.3s; 
        }
        .start-button:hover { 
            background-color: #FF0000; 
            transform: scale(1.1); 
        }
        .hint-box { 
            display: none; 
            background-color: rgba(70, 130, 180, 0.2); 
            padding: 10px; 
            border-radius: 5px; 
            margin-top: 10px; 
        }
        #map { 
            position: relative; 
            min-height: 500px; 
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/4/4f/Three_Kingdoms_%28AD_262%29.png/1200px-Three_Kingdoms_%28AD_262%29.png'); 
            background-size: cover;
            background-position: center;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .stats-table th, .stats-table td {
            border: 1px solid #8B4513;
            padding: 8px;
            text-align: left;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: rgba(255,248,220,0.95);
            padding: 30px;
            border-radius: 10px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 3px solid #8B4513;
            position: relative;
        }
        .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #8B4513;
        }
        .music-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background-color: rgba(255,248,220,0.9);
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #8B4513;
        }
        .event-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 4000;
            justify-content: center;
            align-items: center;
        }
        .event-content {
            background-color: rgba(255,248,220,0.95);
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 80%;
            text-align: center;
            border: 3px solid #8B4513;
        }
        .event-title {
            color: #8B0000;
            font-size: 1.8rem;
            margin-bottom: 20px;
        }
        .event-message {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        .event-button {
            background-color: #8B4513;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
        }
        .resource-button {
            background-color: #4682B4;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 3px 0;
            display: block;
            width: 100%;
            box-sizing: border-box;
            font-size: 0.85rem;
        }
        .victory-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 5000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }
        .victory-title {
            font-size: 4rem;
            color: #FFD700;
            text-shadow: 3px 3px 5px #8B0000;
            margin-bottom: 30px;
            animation: pulse 2s infinite;
        }
        .victory-content {
            max-width: 800px;
            padding: 20px;
            background-color: rgba(255,248,220,0.9);
            border-radius: 10px;
            color: black;
            border: 3px solid #8B4513;
            margin-bottom: 20px;
            opacity: 0;
            transform: translateY(50px);
            transition: all 1s ease-out;
        }
        .city-history-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 4000;
            justify-content: center;
            align-items: center;
        }
        .city-history-content {
            background-color: rgba(255,248,220,0.95);
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 80%;
            border: 3px solid #8B4513;
        }
        .city-history-title {
            color: #8B0000;
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-align: center;
        }
        .city-history-message {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        .city-history-button {
            background-color: #8B4513;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
            display: block;
            margin: 0 auto;
        }
        /* å¹´ä»½å’Œè§’è‰²æ˜¾ç¤ºæ ·å¼ */
        .year-display {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: rgba(255,248,220,0.9);
            padding: 10px 20px;
            border-radius: 5px;
            border: 2px solid #8B4513;
            font-size: 1.2rem;
            z-index: 100;
        }
        /* ç»“ç›ŸæŒ‰é’®æ ·å¼ */
        .alliance-button {
            background-color: #4CAF50;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 3px 0;
            display: block;
            width: 100%;
            box-sizing: border-box;
            font-size: 0.85rem;
        }
        .alliance-button.disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        /* ç»“ç›Ÿæ¨¡æ€æ¡†æ ·å¼ */
        .alliance-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 4000;
            justify-content: center;
            align-items: center;
        }
        .alliance-content {
            background-color: rgba(255,248,220,0.95);
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 80%;
            border: 3px solid #8B4513;
        }
        .alliance-title {
            color: #8B0000;
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-align: center;
        }
        .alliance-message {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        .alliance-button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .alliance-confirm-button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
        }
        .alliance-cancel-button {
            background-color: #f44336;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
        }
        /* èƒŒå›æŒ‰é’®æ ·å¼ */
        #betrayBtn {
            background-color: #f44336;
            display: none;
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        /* å¤„å†³é€‰æ‹©æ¨¡æ€æ¡†æ ·å¼ */
        .execution-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 4000;
            justify-content: center;
            align-items: center;
        }
        .execution-content {
            background-color: rgba(255,248,220,0.95);
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 80%;
            border: 3px solid #8B4513;
        }
        .execution-title {
            color: #8B0000;
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-align: center;
        }
        .execution-message {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        .execution-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        .execution-option {
            background-color: #8B4513;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
            text-align: center;
        }
        /* å¯¹è¯æ¨¡æ€æ¡†æ ·å¼ */
        .dialogue-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 4000;
            justify-content: center;
            align-items: center;
        }
        .dialogue-content {
            background-color: rgba(255,248,220,0.95);
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 80%;
            border: 3px solid #8B4513;
        }
        .dialogue-title {
            color: #8B0000;
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-align: center;
        }
        .dialogue-message {
            font-size: 1.2rem;
            margin-bottom: 20px;
            min-height: 100px;
        }
        .dialogue-speaker {
            font-weight: bold;
            color: #8B0000;
            margin-bottom: 10px;
        }
        .dialogue-button {
            background-color: #8B4513;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
            display: block;
            margin: 0 auto;
        }
        /* æ­¦å°†å¤´åƒæ ·å¼ */
        .character-portrait {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid #8B4513;
            margin: 0 auto 15px;
            background-size: cover;
            background-position: center;
        }
    </style>
</head>
<body>
    <!-- æ·»åŠ å¹´ä»½å’Œè§’è‰²æ˜¾ç¤ºå…ƒç´  -->
    <div class="year-display" id="yearDisplay" style="display: none;">
        <span id="characterName"></span> | å¹´ä»½: 184å¹´
    </div>
    
    <!-- æ·»åŠ éŸ³ä¹æ§åˆ¶æŒ‰é’® -->
    <div class="music-control" id="musicControl" onclick="toggleMusic()">
        <span id="musicIcon">ğŸµ</span>
    </div>
    
    <!-- æ·»åŠ éŸ³é¢‘å…ƒç´  -->
    <audio id="bgMusic" loop>
        <source src="https://music.163.com/song/media/outer/url?id=5271858.mp3" type="audio/mpeg">
    </audio>

    <div class="cover-screen" id="coverScreen">
        <h1 class="cover-title">ä¸‰å›½æ™ºéœ¸</h1>
        <p style="font-size: 1.5rem; margin-bottom: 30px; max-width: 800px; text-align: center;">
            é€šè¿‡å›ç­”ä¸‰å›½å†å²é—®é¢˜æ¥æ”»åŸç•¥åœ°ï¼Œå é¢†æ‰€æœ‰14åº§åŸæ± å³å¯ç»Ÿä¸€å¤©ä¸‹ï¼<br>
            <span style="color: #FFD700;">æ–°å¢éšæœºäº‹ä»¶ç³»ç»Ÿï¼Œä½“éªŒæ›´ä¸°å¯Œçš„ä¸‰å›½äº‰éœ¸ï¼</span>
        </p>
        <button class="start-button" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
    </div>

    <div class="character-selection" id="characterSelection" style="display: none;">
        <div style="background-color: rgba(255,248,220,0.9); padding: 20px; border-radius: 10px; max-width: 800px; margin-bottom: 30px; border: 3px solid #8B4513; color: black;">
            <h1 style="color: #8B0000; text-align: center; font-size: 2.5rem; margin-bottom: 15px;">é€‰æ‹©ä¸»å…¬</h1>
            <p id="selectionPrompt">æ¯ä½ä¸»å…¬æ‹¥æœ‰ä¸åŒçš„åˆå§‹èµ„æºï¼Œé€‰æ‹©ä¸€ä½å¼€å§‹ä½ çš„äº‰éœ¸ä¹‹è·¯ï¼</p>
        </div>
        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px;">
            <div class="character-card" id="caoCaoCard" onclick="selectCharacter('æ›¹æ“')">
                <h2>æ›¹æ“</h2>
                <p>åˆå§‹èµ„é‡‘ï¼š6000ï¼Œç²®è‰ï¼š12000ï¼Œå…µåŠ›ï¼š3500</p>
                <p style="font-style: italic; color: #8B0000;">"å®æ•™æˆ‘è´Ÿå¤©ä¸‹äººï¼Œä¼‘æ•™å¤©ä¸‹äººè´Ÿæˆ‘"</p>
            </div>
            <div class="character-card" id="liuBeiCard" onclick="selectCharacter('åˆ˜å¤‡')">
                <h2>åˆ˜å¤‡</h2>
                <p>åˆå§‹èµ„é‡‘ï¼š5000ï¼Œç²®è‰ï¼š20000ï¼Œå…µåŠ›ï¼š3000</p>
                <p style="font-style: italic; color: #8B0000;">"å‹¿ä»¥æ¶å°è€Œä¸ºä¹‹ï¼Œå‹¿ä»¥å–„å°è€Œä¸ä¸º"</p>
            </div>
            <div class="character-card" id="sunQuanCard" onclick="selectCharacter('å­™æƒ')">
                <h2>å­™æƒ</h2>
                <p>åˆå§‹èµ„é‡‘ï¼š5500ï¼Œç²®è‰ï¼š11000ï¼Œå…µåŠ›ï¼š3200</p>
                <p style="font-style: italic; color: #8B0000;">"èƒ½ç”¨ä¼—åŠ›ï¼Œåˆ™æ— æ•Œäºå¤©ä¸‹çŸ£"</p>
            </div>
        </div>
    </div>
    
    <div class="game-container" id="gameContainer" style="display: none;">
        <div class="panel">
            <h2>ğŸ¯ åŸæ± æ²»ç†</h2>
            <div style="background-color: rgba(255,255,255,0.9); border-radius: 5px; padding: 10px; margin-bottom: 10px; border: 1px solid #8B4513;">
                <div>ğŸ’° èµ„é‡‘ï¼š<span id="gold">0</span></div>
                <div>ğŸŒ¾ ç²®è‰ï¼š<span id="food">0</span></div>
                <div>âš”ï¸ å…µåŠ›ï¼š<span id="troops">0</span></div>
                <div>ğŸ° å·²å é¢†ï¼š<span id="citiesCount">0</span>/14</div>
                <div>âœ… ç­”å¯¹ï¼š<span id="correctCount">0</span> âŒ ç­”é”™ï¼š<span id="wrongCount">0</span></div>
                <div>ğŸŒ± å†œä¸šå‘å±•ç­‰çº§ï¼š<span id="agriLevel">0</span></div>
                <div id="allianceStatus" style="display: none;">ğŸ¤ ç»“ç›Ÿä¸­: <span id="alliedCity"></span></div>
                <div id="reputationDisplay">å£°æœ›: <span id="reputationValue">50</span>/100</div>
            </div>
            <button class="action-button" onclick="game.militaryReform()">å†›äº‹æ”¹é© (æ¶ˆè€—2000é‡‘)</button>
            <button class="action-button" onclick="game.agriculturalDevelopment()">å†œä¸šå‘å±• (æ¶ˆè€—1500é‡‘)</button>
            <button class="action-button" onclick="game.showHint()" style="background-color: #4682B4;">æç¤º</button>
            <button class="action-button" onclick="game.openShop()" style="background-color: #8B008B;">å•†åŸ</button>
            <button class="action-button" onclick="game.showStats()" style="background-color: #556B2F;">ç­”é¢˜ç»Ÿè®¡</button>
            <button class="alliance-button" id="allianceBtn" onclick="game.startAlliance()">ç»“ç›Ÿ</button>
            <button class="alliance-button" id="betrayBtn" onclick="game.betrayAlliance()" style="background-color: #f44336; display: none;">èƒŒå›</button>
            <button class="resource-button" onclick="game.earnResourcesByAnswering()" id="earnResourceBtn" style="display: none;">ç­”é¢˜è·å–èµ„æº</button>
            <button class="action-button" onclick="returnToCharacterSelection()" style="background-color: #FF6347;">è¿”å›è§’è‰²é€‰æ‹©</button>
        </div>
        
        <div class="panel" id="map"></div>
        
        <div class="panel">
            <h2>âš”ï¸ æ”»åŸç•¥åœ°</h2>
            <div id="questionBox" style="background-color: rgba(255,255,255,0.9); border-radius: 5px; padding: 15px; margin-bottom: 10px; border: 1px solid #8B4513;">
                <p>ç‚¹å‡»åœ°å›¾ä¸Šçš„åŸæ± å¼€å§‹æ”»åŸï¼</p>
            </div>
            <div id="progressBox" style="display: none;">
                <p>æ”»åŸè¿›åº¦: <span id="correctAnswers">0</span>/<span id="requiredAnswers">2</span></p>
            </div>
            <div id="hintBox" class="hint-box">
                <h3>ğŸ’¡ æç¤º</h3>
                <p id="hintText"></p>
            </div>
        </div>
    </div>

    <!-- å•†åŸæ¨¡æ€æ¡† -->
    <div class="modal" id="shopModal">
        <div class="modal-content">
            <span class="close-button" onclick="game.closeShop()">&times;</span>
            <h2 style="color: #8B0000; text-align: center; margin-bottom: 20px;">å•†åŸ</h2>
            <div class="panel">
                <div class="shop-item">
                    <div>
                        <h3>å…µåŠ›è¡¥å……åŒ…</h3>
                        <p>ç«‹å³å¢åŠ 1000å…µåŠ›</p>
                    </div>
                    <button class="action-button" onclick="game.buyItem('troops')">è´­ä¹° (3000é‡‘)</button>
                </div>
                <div class="shop-item">
                    <div>
                        <h3>ç²®è‰è¡¥å……åŒ…</h3>
                        <p>ç«‹å³å¢åŠ 5000ç²®è‰</p>
                    </div>
                    <button class="action-button" onclick="game.buyItem('food')">è´­ä¹° (2000é‡‘)</button>
                </div>
                <div class="shop-item">
                    <div>
                        <h3>å…ç­”å¡</h3>
                        <p>æ”»åŸæ—¶å¯å…ç­”ä¸€é¢˜</p>
                    </div>
                    <button class="action-button" onclick="game.buyItem('freeAnswer')">è´­ä¹° (2500é‡‘)</button>
                </div>
                <div class="shop-item">
                    <div>
                        <h3>åŒå€å¥–åŠ±å¡</h3>
                        <p>ä¸‹æ¬¡æ”»åŸæˆåŠŸè·å¾—åŒå€å¥–åŠ±</p>
                    </div>
                    <button class="action-button" onclick="game.buyItem('doubleReward')">è´­ä¹° (4000é‡‘)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç­”é¢˜ç»Ÿè®¡æ¨¡æ€æ¡† -->
    <div class="modal" id="statsModal">
        <div class="modal-content">
            <span class="close-button" onclick="game.closeStats()">&times;</span>
            <h2 style="color: #8B0000; text-align: center; margin-bottom: 20px;">ç­”é¢˜ç»Ÿè®¡</h2>
            <div class="panel">
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>é¢˜ç›®</th>
                            <th>ä½ çš„ç­”æ¡ˆ</th>
                            <th>æ­£ç¡®ç­”æ¡ˆ</th>
                            <th>ç»“æœ</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody">
                        <!-- ç­”é¢˜è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
                <div style="margin-top: 20px; font-weight: bold;">
                    <p>æ€»ç­”é¢˜æ•°: <span id="totalQuestions">0</span></p>
                    <p>æ­£ç¡®ç‡: <span id="accuracyRate">0</span>%</p>
                    <p>è¿ç»­ç­”å¯¹æœ€é«˜è®°å½•: <span id="maxStreak">0</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- éšæœºäº‹ä»¶æ¨¡æ€æ¡† -->
    <div class="event-modal" id="eventModal">
        <div class="event-content">
            <h2 class="event-title" id="eventTitle">éšæœºäº‹ä»¶</h2>
            <p class="event-message" id="eventMessage"></p>
            <button class="event-button" onclick="game.closeEvent()">ç¡®å®š</button>
        </div>
    </div>

    <!-- èµ„æºè·å–æ¨¡æ€æ¡† -->
    <div class="modal" id="resourceModal">
        <div class="modal-content">
            <span class="close-button" onclick="game.closeResourceModal()">&times;</span>
            <h2 style="color: #8B0000; text-align: center; margin-bottom: 20px;">ç­”é¢˜è·å–èµ„æº</h2>
            <div class="panel">
                <div id="resourceQuestionBox"></div>
                <div id="resourceProgressBox" style="display: none;">
                    <p>ç­”é¢˜è¿›åº¦: <span id="resourceCorrectAnswers">0</span>/<span id="resourceRequiredAnswers">3</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- åŸæ± å†å²æ¨¡æ€æ¡† -->
    <div class="city-history-modal" id="cityHistoryModal">
        <div class="city-history-content">
            <h2 class="city-history-title" id="cityHistoryTitle">åŸæ± å†å²</h2>
            <p class="city-history-message" id="cityHistoryMessage"></p>
            <button class="city-history-button" onclick="game.closeCityHistory()">ç¡®å®š</button>
        </div>
    </div>

    <!-- èƒœåˆ©åŠ¨ç”» -->
    <div class="victory-animation" id="victoryAnimation" style="display: none;">
        <h1 class="victory-title">ç»Ÿä¸€å¤©ä¸‹</h1>
        <div class="victory-content" id="victoryContent">
            <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- ç»“ç›Ÿæ¨¡æ€æ¡† -->
    <div class="alliance-modal" id="allianceModal">
        <div class="alliance-content">
            <h2 class="alliance-title">é€‰æ‹©ç»“ç›ŸåŸæ± </h2>
            <p class="alliance-message">è¯·é€‰æ‹©ä¸€ä¸ªæœªè¢«å é¢†çš„åŸæ± è¿›è¡Œç»“ç›Ÿï¼Œæœ‰50%çš„å‡ ç‡æˆåŠŸã€‚ç»“ç›ŸæˆåŠŸåï¼Œæ¯æ”»å 2åº§åŸæ± å¯è·å¾—èµ„æºå’Œå…µåŠ›å¥–åŠ±ã€‚</p>
            <div id="allianceCityList" style="margin-bottom: 20px;">
                <!-- åŸæ± åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="alliance-button-group">
                <button class="alliance-confirm-button" id="confirmAllianceBtn">ç¡®è®¤ç»“ç›Ÿ</button>
                <button class="alliance-cancel-button" onclick="game.closeAllianceModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å¤„å†³é€‰æ‹©æ¨¡æ€æ¡† -->
    <div class="execution-modal" id="executionModal">
        <div class="execution-content">
            <h2 class="execution-title" id="executionTitle">å¤„ç½®å®ˆå°†</h2>
            <p class="execution-message" id="executionMessage">ä½ å·²æ”»ä¸‹åŸæ± ï¼Œå¦‚ä½•å¤„ç½®å®ˆå°†ï¼Ÿ</p>
            <div class="execution-options" id="executionOptions">
                <!-- é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- å¯¹è¯æ¨¡æ€æ¡† -->
    <div class="dialogue-modal" id="dialogueModal">
        <div class="dialogue-content">
            <div class="character-portrait" id="dialoguePortrait"></div>
            <h2 class="dialogue-title" id="dialogueTitle">å¯¹è¯</h2>
            <div class="dialogue-speaker" id="dialogueSpeaker"></div>
            <p class="dialogue-message" id="dialogueMessage"></p>
            <button class="dialogue-button" onclick="game.nextDialogue()" id="dialogueNextBtn">ç»§ç»­</button>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡ï¼Œè®°å½•å·²é€‰è§’è‰²
        const selectedCharacters = new Set();
        
        // åŸæ± å†å²ä¿¡æ¯ - æ·»åŠ ç°ä»£ä½ç½®ä¿¡æ¯
        const CITY_HISTORIES = {
            'æ´›é˜³': 'æ´›é˜³æ˜¯ä¸œæ±‰çš„éƒ½åŸï¼Œä¹Ÿæ˜¯ä¸‰å›½æ—¶æœŸçš„é‡è¦æ”¿æ²»ä¸­å¿ƒã€‚å…¬å…ƒ190å¹´ï¼Œè‘£å“æŒŸæŒæ±‰çŒ®å¸è¿éƒ½é•¿å®‰ï¼Œç«çƒ§æ´›é˜³ï¼Œä½¿è¿™åº§åƒå¹´å¤éƒ½åŒ–ä¸ºåºŸå¢Ÿã€‚åæ¥æ›¹æ“è¿æ±‰çŒ®å¸è¿éƒ½è®¸æ˜Œï¼Œæ´›é˜³é€æ¸æ¢å¤ã€‚\n\nç°ä»£ä½ç½®ï¼šä»Šæ²³å—çœæ´›é˜³å¸‚',
            'æˆéƒ½': 'æˆéƒ½æ˜¯èœ€æ±‰çš„é¦–éƒ½ï¼Œåˆ˜å¤‡äºå…¬å…ƒ221å¹´åœ¨æ­¤ç§°å¸ã€‚è¯¸è‘›äº®åœ¨æ­¤æ¨è¡Œå±¯ç”°æ”¿ç­–ï¼Œå‘å±•å†œä¸šï¼Œä½¿æˆéƒ½æˆä¸ºè¥¿å—åœ°åŒºçš„ç»æµæ–‡åŒ–ä¸­å¿ƒã€‚æˆéƒ½ä¹Ÿæ˜¯èœ€é”¦çš„å‘æºåœ°ï¼Œç»æµç¹è£ã€‚\n\nç°ä»£ä½ç½®ï¼šä»Šå››å·çœæˆéƒ½å¸‚',
            'è®¸æ˜Œ': 'è®¸æ˜Œæ˜¯æ›¹æ“çš„æ”¿æ²»ä¸­å¿ƒï¼Œå…¬å…ƒ196å¹´æ›¹æ“è¿æ±‰çŒ®å¸è¿éƒ½äºæ­¤ï¼Œå¼€å§‹äº†"æŒŸå¤©å­ä»¥ä»¤è¯¸ä¾¯"çš„æ—¶ä»£ã€‚è®¸æ˜Œæˆä¸ºåŒ—æ–¹çš„æ”¿æ²»ã€å†›äº‹ä¸­å¿ƒï¼Œæ›¹æ“åœ¨æ­¤æ¨è¡Œå±¯ç”°åˆ¶ï¼Œå‘å±•ç»æµã€‚\n\nç°ä»£ä½ç½®ï¼šä»Šæ²³å—çœè®¸æ˜Œå¸‚',
            'å»ºä¸š': 'å»ºä¸š(ä»Šå—äº¬)æ˜¯ä¸œå´çš„é¦–éƒ½ï¼Œå­™æƒäºå…¬å…ƒ229å¹´åœ¨æ­¤ç§°å¸ã€‚å»ºä¸šä½äºé•¿æ±Ÿä¸‹æ¸¸ï¼Œæ°´è¿ä¾¿åˆ©ï¼Œæ˜¯ä¸œå´çš„æ”¿æ²»ã€ç»æµä¸­å¿ƒã€‚å­™æƒåœ¨æ­¤ä¿®å»ºçŸ³å¤´åŸï¼ŒåŠ å¼ºé˜²å¾¡ã€‚\n\nç°ä»£ä½ç½®ï¼šä»Šæ±Ÿè‹çœå—äº¬å¸‚',
            'é•¿å®‰': 'é•¿å®‰æ˜¯è¥¿æ±‰çš„éƒ½åŸï¼Œè‘£å“æŒŸæŒæ±‰çŒ®å¸è¿éƒ½äºæ­¤ã€‚åæ¥æˆä¸ºè¥¿æ™‹çš„éƒ½åŸã€‚é•¿å®‰åœ°å¤„å…³ä¸­å¹³åŸï¼Œæ˜“å®ˆéš¾æ”»ï¼Œæ˜¯è¥¿åŒ—åœ°åŒºçš„æ”¿æ²»ã€ç»æµä¸­å¿ƒã€‚\n\nç°ä»£ä½ç½®ï¼šä»Šé™•è¥¿çœè¥¿å®‰å¸‚',
            'è†å·': 'è†å·åœ°å¤„é•¿æ±Ÿä¸­æ¸¸ï¼Œæ˜¯ä¸‰å›½æ—¶æœŸçš„æˆ˜ç•¥è¦åœ°ã€‚èµ¤å£ä¹‹æˆ˜åï¼Œè†å·è¢«é­ã€èœ€ã€å´ä¸‰æ–¹äº‰å¤ºï¼Œå…³ç¾½æ›¾é•‡å®ˆè†å·ï¼Œåè¢«å•è’™å·è¢­å¤±å»ã€‚\n\nç°ä»£ä½ç½®ï¼šä»Šæ¹–åŒ—çœè†å·å¸‚',
            'å¾å·': 'å¾å·åœ°å¤„ä¸­åŸä¸œéƒ¨ï¼Œæ˜¯è¿æ¥å—åŒ—çš„äº¤é€šè¦é“ã€‚é™¶è°¦æ›¾ä»»å¾å·ç‰§ï¼Œåè®©ä½äºåˆ˜å¤‡ã€‚æ›¹æ“ä¸ºæŠ¥çˆ¶ä»‡æ›¾æ”»æ‰“å¾å·ï¼Œé€ æˆå¤§è§„æ¨¡å± æ€ã€‚\n\nç°ä»£ä½ç½®ï¼šä»Šæ±Ÿè‹çœå¾å·å¸‚',
            'è¥„é˜³': 'è¥„é˜³æ˜¯è†å·åŒ—éƒ¨é‡é•‡ï¼Œåˆ˜è¡¨æ›¾åœ¨æ­¤æ²»ç†è†å·ã€‚è¯¸è‘›äº®æ›¾åœ¨æ­¤éšå±…ï¼Œååˆ˜å¤‡ä¸‰é¡¾èŒ…åºè¯·å…¶å‡ºå±±ã€‚è¥„é˜³ä¹Ÿæ˜¯å—åŒ—äº¤é€šè¦é“ï¼Œæˆ˜ç•¥åœ°ä½é‡è¦ã€‚\n\nç°ä»£ä½ç½®ï¼šä»Šæ¹–åŒ—çœè¥„é˜³å¸‚',
            'å®›åŸ': 'å®›åŸæ˜¯å—é˜³éƒ¡æ²»æ‰€ï¼Œå¼ ç»£æ›¾åœ¨æ­¤å‰²æ®ã€‚æ›¹æ“å¾è®¨å¼ ç»£æ—¶ï¼Œå› å¼ºå å¼ ç»£å©¶å©¶é‚¹æ°ï¼Œå¼•å‘å¼ ç»£åå›ï¼Œå¯¼è‡´æ›¹æ“é•¿å­æ›¹æ˜‚ã€å¤§å°†å…¸éŸ¦æˆ˜æ­»ã€‚\n\nç°ä»£ä½ç½®ï¼šä»Šæ²³å—çœå—é˜³å¸‚',
            'å—éƒ¡': 'å—éƒ¡æ˜¯è†å·çš„é‡è¦éƒ¡å¿ï¼Œæ›¹ä»æ›¾é•‡å®ˆäºæ­¤ã€‚å‘¨ç‘œæ›¾ç‡å†›æ”»æ‰“å—éƒ¡ï¼Œä¸æ›¹ä»æ¿€æˆ˜ä¸€å¹´æœ‰ä½™ï¼Œæœ€ç»ˆå¤ºå–å—éƒ¡ï¼Œä½†è‡ªå·±ä¹Ÿä¸­ç®­å—ä¼¤ã€‚\n\nç°ä»£ä½ç½®ï¼šä»Šæ¹–åŒ—çœè†å·å¸‚æ±Ÿé™µå¿',
            'æ±‰ä¸­': 'æ±‰ä¸­æ˜¯ç›Šå·åŒ—éƒ¨é‡é•‡ï¼Œå¼ é²åœ¨æ­¤åˆ›ç«‹äº”æ–—ç±³é“ã€‚æ›¹æ“æ”»å æ±‰ä¸­åï¼Œåˆ˜å¤‡ä¸æ›¹æ“å±•å¼€æ±‰ä¸­ä¹‹æˆ˜ï¼Œæœ€ç»ˆåˆ˜å¤‡è·èƒœï¼Œè‡ªç§°æ±‰ä¸­ç‹ã€‚\n\nç°ä»£ä½ç½®ï¼šä»Šé™•è¥¿çœæ±‰ä¸­å¸‚',
            'æ±Ÿå¤': 'æ±Ÿå¤ä½äºé•¿æ±Ÿä¸­æ¸¸ï¼Œæ˜¯è†å·ä¸œéƒ¨é‡é•‡ã€‚é»„ç¥–æ›¾é•‡å®ˆæ±Ÿå¤ï¼Œåè¢«å­™æƒéƒ¨å°†ç”˜å®å°„æ€ã€‚èµ¤å£ä¹‹æˆ˜åï¼Œæ±Ÿå¤æˆä¸ºå´èœ€äº‰å¤ºçš„è¦åœ°ã€‚\n\nç°ä»£ä½ç½®ï¼šä»Šæ¹–åŒ—çœæ­¦æ±‰å¸‚æ±Ÿå¤åŒº',
            'åˆè‚¥': 'åˆè‚¥æ˜¯æ·®å—é‡é•‡ï¼Œæ›¹æ“æ´¾å¼ è¾½é•‡å®ˆã€‚å…¬å…ƒ215å¹´ï¼Œå­™æƒç‡åä¸‡å¤§å†›æ”»æ‰“åˆè‚¥ï¼Œè¢«å¼ è¾½ä»¥å…«ç™¾ç²¾å…µå‡»é€€ï¼Œå²ç§°"é€é¥æ´¥ä¹‹æˆ˜"ã€‚\n\nç°ä»£ä½ç½®ï¼šä»Šå®‰å¾½çœåˆè‚¥å¸‚',
            'é‚ºåŸ': 'é‚ºåŸæ˜¯æ²³åŒ—é‡é•‡ï¼Œè¢ç»çš„å¤§æœ¬è¥ã€‚å®˜æ¸¡ä¹‹æˆ˜åï¼Œæ›¹æ“æ”»å é‚ºåŸï¼Œåæˆä¸ºæ›¹é­çš„é™ªéƒ½ã€‚æ›¹ä¸•ç§°å¸åï¼Œé‚ºåŸä»æ˜¯åŒ—æ–¹é‡è¦åŸå¸‚ã€‚\n\nç°ä»£ä½ç½®ï¼šä»Šæ²³åŒ—çœä¸´æ¼³å¿'
        };

        // ä¸»å…¬ç”Ÿå¹³ä¿¡æ¯
        const CHARACTER_HISTORIES = {
            'æ›¹æ“': 'æ›¹æ“(155å¹´-220å¹´)ï¼Œå­—å­Ÿå¾·ï¼Œæ²›å›½è°¯å¿(ä»Šå®‰å¾½äº³å·)äººã€‚ä¸œæ±‰æœ«å¹´æ°å‡ºçš„æ”¿æ²»å®¶ã€å†›äº‹å®¶ã€æ–‡å­¦å®¶ã€ä¹¦æ³•å®¶ï¼Œä¸‰å›½ä¸­æ›¹é­æ”¿æƒçš„å¥ åŸºäººã€‚\n\n' +
                   'æ›¹æ“å¹´è½»æ—¶ä¸¾å­å»‰å…¥ä»•ï¼Œåå‚ä¸é•‡å‹é»„å·¾èµ·ä¹‰ã€‚è‘£å“ä¹±æ”¿æ—¶ï¼Œæ›¹æ“æ•£å®¶è´¢èµ·å…µè®¨ä¼ã€‚å…¬å…ƒ196å¹´è¿æ±‰çŒ®å¸è¿éƒ½è®¸æ˜Œï¼ŒæŒŸå¤©å­ä»¥ä»¤è¯¸ä¾¯ã€‚\n\n' +
                   'æ›¹æ“å…ˆåå‡»è´¥å•å¸ƒã€è¢æœ¯ã€è¢ç»ç­‰å‰²æ®åŠ¿åŠ›ï¼Œç»Ÿä¸€äº†ä¸­å›½åŒ—æ–¹ã€‚å®è¡Œå±¯ç”°åˆ¶ï¼Œæ¢å¤ç»æµï¼›å”¯æ‰æ˜¯ä¸¾ï¼Œæ‰“ç ´ä¸–æ—å„æ–­ï¼›ç²¾äºå…µæ³•ï¼Œè‘—æœ‰ã€Šå­™å­ç•¥è§£ã€‹ã€‚\n\n' +
                   'æ›¹æ“ä¸€ç”Ÿæœªç§°å¸ï¼Œ220å¹´ç—…é€äºæ´›é˜³ï¼Œå…¶å­æ›¹ä¸•ç§°å¸åè¿½å°Šä¸ºé­æ­¦å¸ã€‚æ›¹æ“åœ¨æ–‡å­¦ä¸Šä¹Ÿæœ‰å¾ˆé«˜æˆå°±ï¼Œä¸å…¶å­æ›¹ä¸•ã€æ›¹æ¤å¹¶ç§°"ä¸‰æ›¹"ã€‚',
            'åˆ˜å¤‡': 'åˆ˜å¤‡(161å¹´-223å¹´)ï¼Œå­—ç„å¾·ï¼Œæ¶¿éƒ¡æ¶¿å¿(ä»Šæ²³åŒ—æ¶¿å·)äººã€‚è¥¿æ±‰ä¸­å±±é–ç‹åˆ˜èƒœä¹‹åï¼Œä¸‰å›½æ—¶æœŸèœ€æ±‰å¼€å›½çš‡å¸ã€‚\n\n' +
                   'åˆ˜å¤‡æ—©å¹´ä»¥è´©å±¥ç»‡å¸­ä¸ºä¸šï¼Œåä¸å…³ç¾½ã€å¼ é£æ¡ƒå›­ç»“ä¹‰ï¼Œå‚ä¸é•‡å‹é»„å·¾èµ·ä¹‰ã€‚å…ˆåä¾é™„å…¬å­™ç“’ã€é™¶è°¦ã€æ›¹æ“ã€è¢ç»ã€åˆ˜è¡¨ç­‰ã€‚\n\n' +
                   'ä¸‰é¡¾èŒ…åºè¯·è¯¸è‘›äº®å‡ºå±±åï¼Œè”åˆå­™æƒåœ¨èµ¤å£ä¹‹æˆ˜å‡»è´¥æ›¹æ“ï¼Œå æ®è†å·ã€‚åå…¥èœ€å¤ºå–ç›Šå·ï¼Œ219å¹´è‡ªç§°æ±‰ä¸­ç‹ã€‚221å¹´åœ¨æˆéƒ½ç§°å¸ï¼Œå›½å·æ±‰ï¼Œå²ç§°èœ€æ±‰ã€‚\n\n' +
                   '222å¹´ï¼Œåˆ˜å¤‡ä¸ºæŠ¥å…³ç¾½ä¹‹ä»‡ï¼Œå‘åŠ¨å¤·é™µä¹‹æˆ˜ï¼Œè¢«é™†é€Šç«çƒ§è¿è¥ï¼Œå¤§è´¥è€Œå½’ã€‚223å¹´ç—…é€äºç™½å¸åŸï¼Œæ‰˜å­¤äºè¯¸è‘›äº®ã€‚è°¥å·æ˜­çƒˆçš‡å¸ã€‚',
            'å­™æƒ': 'å­™æƒ(182å¹´-252å¹´)ï¼Œå­—ä»²è°‹ï¼Œå´éƒ¡å¯Œæ˜¥(ä»Šæµ™æ±Ÿå¯Œé˜³)äººã€‚ä¸‰å›½æ—¶æœŸä¸œå´å¼€å›½çš‡å¸ï¼Œå­™åšæ¬¡å­ï¼Œå­™ç­–ä¹‹å¼Ÿã€‚\n\n' +
                   '200å¹´å­™ç­–é‡åˆºèº«äº¡ï¼Œ18å²çš„å­™æƒç»§ä½ã€‚åœ¨å‘¨ç‘œã€å¼ æ˜­ç­‰äººè¾…ä½ä¸‹ç¨³å®šæ±Ÿä¸œã€‚208å¹´è”åˆåˆ˜å¤‡åœ¨èµ¤å£ä¹‹æˆ˜å‡»è´¥æ›¹æ“ï¼Œå¥ å®šä¸‰å›½é¼ç«‹åŸºç¡€ã€‚\n\n' +
                   '222å¹´ç§°å´ç‹ï¼Œ229å¹´æ­£å¼ç§°å¸ï¼Œå›½å·å´ï¼Œå®šéƒ½å»ºä¸š(ä»Šå—äº¬)ã€‚åœ¨ä½æœŸé—´ï¼Œå¼€å‘æ±Ÿå—ï¼Œå‘å±•æµ·ä¸Šè´¸æ˜“ï¼›æ´¾å«æ¸©ã€è¯¸è‘›ç›´èˆªæµ·è‡³å¤·æ´²(ä»Šå°æ¹¾)ã€‚\n\n' +
                   'å­™æƒæ™šå¹´å¤šç–‘ï¼Œå¼•å‘äºŒå®«ä¹‹äº‰ï¼Œå¯¼è‡´è®¸å¤šå¤§è‡£è¢«æ€æˆ–æµæ”¾ã€‚252å¹´ç—…é€ï¼Œäº«å¹´70å²ï¼Œè°¥å·å¤§çš‡å¸ï¼Œåº™å·å¤ªç¥–ã€‚'
        };

        // æ­¦å°†å¯¹è¯ä¿¡æ¯
        const GENERAL_DIALOGUES = {
            'è‘£å“': [
                { speaker: 'è‘£å“', message: 'å“ˆå“ˆå“ˆï¼æˆ‘è‘£å“æ‰‹æ¡é‡å…µï¼Œæœå»·ä¸Šä¸‹è°æ•¢ä¸ä»ï¼Ÿ' },
                { speaker: 'è‘£å“', message: 'ä½ è¿™å°å„¿ä¹Ÿæ•¢æ¥çŠ¯æˆ‘æ´›é˜³ï¼Ÿçœ‹æˆ‘å¦‚ä½•æ”¶æ‹¾ä½ ï¼' },
                { speaker: 'è‘£å“', message: 'å•å¸ƒï¼æˆ‘å„¿ä½•åœ¨ï¼Ÿå¿«æ›¿æˆ‘æ€äº†è¿™å®ï¼' }
            ],
            'åˆ˜ç’‹': [
                { speaker: 'åˆ˜ç’‹', message: 'æˆ‘ç›Šå·å¤©åºœä¹‹å›½ï¼Œå…µç²¾ç²®è¶³ï¼Œå²‚æ˜¯ä½ èƒ½è½»æ˜“æ”»ä¸‹çš„ï¼Ÿ' },
                { speaker: 'åˆ˜ç’‹', message: 'å¼ ä»»ã€ä¸¥é¢œï¼Œé€Ÿé€Ÿå¸ƒé˜²ï¼Œç»ä¸èƒ½è®©æ•Œå†›æ”»å…¥æˆéƒ½ï¼' },
                { speaker: 'åˆ˜ç’‹', message: 'å”‰...æˆ‘æœ¬ä»æ…ˆä¹‹ä¸»ï¼Œå¥ˆä½•å¤©ä¸‹å¤§ä¹±...' }
            ],
            'å¼ æµ': [
                { speaker: 'å¼ æµ', message: 'è®¸æ˜Œä¹ƒæ›¹æ“é‡åœ°ï¼Œå²‚å®¹ä½ ç­‰è½»æ˜“æ”»å–ï¼Ÿ' },
                { speaker: 'å¼ æµ', message: 'æˆ‘ä¾„å¼ ç»£å‹‡çŒ›è¿‡äººï¼Œå®šèƒ½å®ˆä½æ­¤åŸï¼' },
                { speaker: 'å¼ æµ', message: 'è‹¥ä½ è‚¯é€€å…µï¼Œæˆ‘å¯è€ƒè™‘ä¸ä½ ç»“ç›Ÿ...' }
            ],
            'åˆ˜ç¹‡': [
                { speaker: 'åˆ˜ç¹‡', message: 'æ±Ÿä¸œä¹‹åœ°ï¼Œæ°´ç½‘å¯†å¸ƒï¼Œä½ åŒ—æ–¹ä¹‹å…µå²‚èƒ½é€‚åº”ï¼Ÿ' },
                { speaker: 'åˆ˜ç¹‡', message: 'å¤ªå²æ…ˆä½•åœ¨ï¼Ÿé€Ÿé€Ÿè¿æ•Œï¼' },
                { speaker: 'åˆ˜ç¹‡', message: 'å­™ç­–å°å„¿å·²å æ®æ±Ÿä¸œå¤§éƒ¨ï¼Œå¦‚ä»Šä½ åˆæ¥çŠ¯...' }
            ],
            'æå‚•': [
                { speaker: 'æå‚•', message: 'é•¿å®‰ä¹ƒå¸éƒ½æ‰€åœ¨ï¼Œå²‚æ˜¯ä½ ç­‰èƒ½è§Šè§çš„ï¼Ÿ' },
                { speaker: 'æå‚•', message: 'éƒ­æ±œï¼é€Ÿé€Ÿè°ƒå…µï¼Œä¸æˆ‘ä¸€åŒå¾¡æ•Œï¼' },
                { speaker: 'æå‚•', message: 'å½“å¹´æˆ‘ä¸éƒ­æ±œè”æ‰‹ï¼Œè¿å•å¸ƒéƒ½å¥ˆä½•ä¸å¾—æˆ‘ä»¬ï¼' }
            ],
            'åˆ˜è¡¨': [
                { speaker: 'åˆ˜è¡¨', message: 'è†å·å…«éƒ¡ï¼Œå¸¦ç”²åä¸‡ï¼Œä½ åŒºåŒºå…µåŠ›ä¹Ÿæ•¢æ¥çŠ¯ï¼Ÿ' },
                { speaker: 'åˆ˜è¡¨', message: 'è’¯è¶Šã€è”¡ç‘ï¼Œé€Ÿé€Ÿå•†è®®å¯¹ç­–ï¼' },
                { speaker: 'åˆ˜è¡¨', message: 'æˆ‘æœ¬æ±‰å®¤å®—äº²ï¼Œåªæ±‚ä¿å¢ƒå®‰æ°‘...' }
            ],
            'é™¶è°¦': [
                { speaker: 'é™¶è°¦', message: 'å¾å·ç™¾å§“å®‰å±…ä¹ä¸šï¼Œä¸ºä½•è¦å…´å…µæ¥çŠ¯ï¼Ÿ' },
                { speaker: 'é™¶è°¦', message: 'æ›¹æ“ä¸ºæŠ¥çˆ¶ä»‡ï¼Œæ›¾å± æˆ‘å¾å·ç™¾å§“...' },
                { speaker: 'é™¶è°¦', message: 'è‹¥èƒ½è®©å¾å·ç™¾å§“å…äºæˆ˜ç«ï¼Œæˆ‘æ„¿è®©å‡ºå¾å·...' }
            ],
            'è”¡ç‘': [
                { speaker: 'è”¡ç‘', message: 'è¥„é˜³åŸé«˜æ± æ·±ï¼Œä½ å¦‚ä½•æ”»å¾—ä¸‹ï¼Ÿ' },
                { speaker: 'è”¡ç‘', message: 'æˆ‘è”¡æ°å®¶æ—åœ¨è†å·æ ¹æ·±è’‚å›ºï¼Œå²‚æ˜¯ä½ èƒ½æ’¼åŠ¨çš„ï¼Ÿ' },
                { speaker: 'è”¡ç‘', message: 'åˆ˜è¡¨å¹´è€ï¼Œè†å·è¿Ÿæ—©æ˜¯æˆ‘è”¡å®¶çš„...' }
            ],
            'å¼ ç»£': [
                { speaker: 'å¼ ç»£', message: 'å®›åŸè™½å°ï¼Œå´æ˜¯æˆ‘å¼ ç»£ç«‹è¶³ä¹‹åœ°ï¼' },
                { speaker: 'å¼ ç»£', message: 'è´¾è¯©å…ˆç”Ÿï¼Œå¦‚ä»Šæ•Œå†›æ¥çŠ¯ï¼Œè¯¥å¦‚ä½•æ˜¯å¥½ï¼Ÿ' },
                { speaker: 'å¼ ç»£', message: 'æ›¹æ“æ›¾å®³æˆ‘å”çˆ¶ï¼Œæ­¤ä»‡ä¸å…±æˆ´å¤©ï¼' }
            ],
            'æ›¹ä»': [
                { speaker: 'æ›¹ä»', message: 'æˆ‘ä¹ƒæ›¹é­å¤§å°†æ›¹ä»ï¼Œå¥‰å‘½é•‡å®ˆå—éƒ¡ï¼' },
                { speaker: 'æ›¹ä»', message: 'å‘¨ç‘œæ›¾åœ¨æ­¤ä¸æˆ‘æ¿€æˆ˜ä¸€å¹´æœ‰ä½™...' },
                { speaker: 'æ›¹ä»', message: 'å—éƒ¡ä¹ƒæˆ˜ç•¥è¦åœ°ï¼Œç»ä¸èƒ½å¤±ï¼' }
            ],
            'å¼ é²': [
                { speaker: 'å¼ é²', message: 'æˆ‘äº”æ–—ç±³é“ä»¥ä»ä¹‰æ²»æ°‘ï¼Œæ±‰ä¸­ç™¾å§“å®‰å±…ä¹ä¸šã€‚' },
                { speaker: 'å¼ é²', message: 'æ›¹æ“æ›¾æ¥æ”»æ±‰ä¸­ï¼Œè¢«æˆ‘å†›å‡»é€€...' },
                { speaker: 'å¼ é²', message: 'è‹¥ä½ èƒ½å–„å¾…æˆ‘æ•™ä¼—ï¼Œæˆ‘å¯è€ƒè™‘å½’é¡º...' }
            ],
            'é»„ç¥–': [
                { speaker: 'é»„ç¥–', message: 'æ±Ÿå¤ä¹ƒè†å·é—¨æˆ·ï¼Œå²‚å®¹ä½ ç­‰è½»æ˜“æ”»å–ï¼Ÿ' },
                { speaker: 'é»„ç¥–', message: 'ç”˜å®é‚£å›è´¼æ›¾å°„æ€æˆ‘éƒ¨å°†...' },
                { speaker: 'é»„ç¥–', message: 'åˆ˜è¡¨å¾…æˆ‘ä¸è–„ï¼Œæˆ‘èª“æ­»å®ˆä½æ±Ÿå¤ï¼' }
            ],
            'å¼ è¾½': [
                { speaker: 'å¼ è¾½', message: 'æˆ‘å¼ æ–‡è¿œåœ¨æ­¤ï¼Œè°æ•¢çŠ¯æˆ‘åˆè‚¥ï¼Ÿ' },
                { speaker: 'å¼ è¾½', message: 'é€é¥æ´¥ä¸€æˆ˜ï¼Œæˆ‘ä»¥å…«ç™¾ç ´åä¸‡ï¼' },
                { speaker: 'å¼ è¾½', message: 'åˆè‚¥ä¹ƒæ›¹é­ä¸œå—å±éšœï¼Œç»ä¸èƒ½å¤±ï¼' }
            ],
            'è¢ç»': [
                { speaker: 'è¢ç»', message: 'æˆ‘è¢æœ¬åˆå››ä¸–ä¸‰å…¬ï¼Œé—¨ç”Ÿæ•…åéå¤©ä¸‹ï¼' },
                { speaker: 'è¢ç»', message: 'é¢œè‰¯ã€æ–‡ä¸‘ï¼Œé€Ÿé€Ÿè¿æ•Œï¼' },
                { speaker: 'è¢ç»', message: 'å®˜æ¸¡ä¸€æˆ˜...å”‰...ä¸æä¹Ÿç½¢...' }
            ]
        };

        // å†å²äº‹ä»¶é…ç½® - ä¿®æ”¹ä¸ºæ ¹æ®ä¸åŒä¸»å…¬æœ‰ä¸åŒçš„å½±å“
        const HISTORICAL_EVENTS = {
            184: { 
                title: "é»„å·¾èµ·ä¹‰", 
                message: "å¼ è§’å‘åŠ¨é»„å·¾èµ·ä¹‰ï¼Œå¤©ä¸‹å¤§ä¹±ï¼", 
                effect: (game) => {
                    let effectMsg = "";
                    if (game.character === 'æ›¹æ“') {
                        game.state.troops += 1000; // æ›¹æ“å‚ä¸é•‡å‹é»„å·¾å†›ï¼Œè·å¾—å…µåŠ›
                        effectMsg = "ä½ å‚ä¸é•‡å‹é»„å·¾å†›ï¼Œè·å¾—1000å…µåŠ›ï¼";
                    } else if (game.character === 'åˆ˜å¤‡') {
                        game.state.troops += 800; // åˆ˜å¤‡ä¹Ÿå‚ä¸é•‡å‹ï¼Œä½†ä¸å¦‚æ›¹æ“
                        effectMsg = "ä½ å‚ä¸é•‡å‹é»„å·¾å†›ï¼Œè·å¾—800å…µåŠ›ï¼";
                    } else {
                        game.state.food -= 2000; // å­™æƒå½“æ—¶å¹´å¹¼ï¼Œé¢†åœ°å—å½±å“
                        effectMsg = "é»„å·¾å†›æ´»åŠ¨å½±å“ä½ çš„é¢†åœ°ï¼ŒæŸå¤±2000ç²®è‰ï¼";
                    }
                    return effectMsg;
                } 
            },
            190: { 
                title: "è‘£å“ä¹±æ”¿", 
                message: "è‘£å“åºŸå°‘å¸ï¼Œç«‹çŒ®å¸ï¼ŒæŠŠæŒæœæ”¿ï¼", 
                effect: (game) => {
                    let effectMsg = "";
                    if (game.character === 'æ›¹æ“') {
                        game.state.gold += 1500; // æ›¹æ“æ•£å®¶è´¢èµ·å…µè®¨è‘£
                        effectMsg = "ä½ æ•£å®¶è´¢èµ·å…µè®¨è‘£ï¼Œè·å¾—1500é‡‘ï¼";
                    } else if (game.character === 'åˆ˜å¤‡') {
                        game.state.troops += 500; // åˆ˜å¤‡å‚ä¸è®¨è‘£
                        effectMsg = "ä½ å‚ä¸è®¨ä¼è‘£å“ï¼Œè·å¾—500å…µåŠ›ï¼";
                    } else {
                        // å­™æƒå½“æ—¶å¹´å¹¼ï¼Œä¸å—å½±å“
                        effectMsg = "ä½ å¹´çºªå°šå°ï¼Œæœªå‚ä¸è®¨è‘£ã€‚";
                    }
                    return effectMsg;
                } 
            },
            200: { 
                title: "å®˜æ¸¡ä¹‹æˆ˜", 
                message: "æ›¹æ“ä¸è¢ç»åœ¨å®˜æ¸¡å±•å¼€å†³æˆ˜ï¼", 
                effect: (game) => {
                    let effectMsg = "";
                    if (game.character === 'æ›¹æ“') {
                        game.state.troops += 2000; // æ›¹æ“å¤§èƒœ
                        game.state.gold += 3000;
                        effectMsg = "ä½ å¤§è´¥è¢ç»ï¼Œè·å¾—2000å…µåŠ›å’Œ3000é‡‘ï¼";
                    } else if (game.character === 'åˆ˜å¤‡') {
                        game.state.troops -= 500; // åˆ˜å¤‡ä¾é™„è¢ç»ï¼Œå—å½±å“
                        effectMsg = "ä½ ä¾é™„è¢ç»ï¼Œå—å®˜æ¸¡ä¹‹æˆ˜å½±å“ï¼ŒæŸå¤±500å…µåŠ›ï¼";
                    } else {
                        // å­™æƒè¶æœºå‘å±•
                        game.state.food += 2000;
                        effectMsg = "ä½ è¶æœºå‘å±•æ±Ÿä¸œï¼Œè·å¾—2000ç²®è‰ï¼";
                    }
                    return effectMsg;
                } 
            },
            208: { 
                title: "èµ¤å£ä¹‹æˆ˜", 
                message: "å­™åˆ˜è”å†›åœ¨èµ¤å£å¤§è´¥æ›¹æ“ï¼", 
                effect: (game) => {
                    let effectMsg = "";
                    if (game.character === 'æ›¹æ“') {
                        game.state.troops = Math.floor(game.state.troops * 0.7); // æ›¹æ“å¤§è´¥
                        effectMsg = "ä½ åœ¨èµ¤å£å¤§è´¥ï¼ŒæŸå¤±30%å…µåŠ›ï¼";
                    } else if (game.character === 'åˆ˜å¤‡') {
                        game.state.troops += 1500; // åˆ˜å¤‡è·åˆ©
                        game.state.gold += 2000;
                        effectMsg = "ä½ ä¸å­™æƒè”åˆå¤§è´¥æ›¹æ“ï¼Œè·å¾—1500å…µåŠ›å’Œ2000é‡‘ï¼";
                    } else {
                        game.state.troops += 2000; // å­™æƒè·åˆ©æœ€å¤š
                        game.state.gold += 3000;
                        effectMsg = "ä½ ä¸åˆ˜å¤‡è”åˆå¤§è´¥æ›¹æ“ï¼Œè·å¾—2000å…µåŠ›å’Œ3000é‡‘ï¼";
                    }
                    return effectMsg;
                } 
            },
            220: { 
                title: "æ›¹ä¸•ç§°å¸", 
                message: "æ›¹ä¸•é€¼è¿«æ±‰çŒ®å¸ç¦…ä½ï¼Œå»ºç«‹é­å›½ï¼", 
                effect: (game) => {
                    let effectMsg = "";
                    if (game.character === 'æ›¹æ“') {
                        // æ›¹æ“å·²å»ä¸–ï¼Œæ¸¸æˆä¸­çš„ç»§æ‰¿è€…
                        game.state.troops += 2500;
                        game.state.gold += 4000;
                        effectMsg = "ä½ çš„ç»§æ‰¿è€…æ›¹ä¸•ç§°å¸ï¼Œè·å¾—2500å…µåŠ›å’Œ4000é‡‘ï¼";
                    } else if (game.character === 'åˆ˜å¤‡') {
                        game.state.troops += 1000; // åˆ˜å¤‡å‡†å¤‡ç§°å¸
                        effectMsg = "æ›¹ä¸•ç¯¡æ±‰ï¼Œä½ å‡†å¤‡ç§°å¸ï¼Œè·å¾—1000å…µåŠ›ï¼";
                    } else {
                        game.state.food += 3000; // å­™æƒè§‚æœ›
                        effectMsg = "æ›¹ä¸•ç§°å¸ï¼Œä½ æš‚æ—¶è§‚æœ›ï¼Œè·å¾—3000ç²®è‰ï¼";
                    }
                    return effectMsg;
                } 
            },
            221: { 
                title: "åˆ˜å¤‡ç§°å¸", 
                message: "åˆ˜å¤‡åœ¨æˆéƒ½ç§°å¸ï¼Œå»ºç«‹èœ€æ±‰ï¼", 
                effect: (game) => {
                    let effectMsg = "";
                    if (game.character === 'æ›¹æ“') {
                        game.state.troops += 1000; // é­å›½åŠ å¼ºé˜²å¾¡
                        effectMsg = "åˆ˜å¤‡ç§°å¸ï¼Œä½ åŠ å¼ºé˜²å¾¡ï¼Œè·å¾—1000å…µåŠ›ï¼";
                    } else if (game.character === 'åˆ˜å¤‡') {
                        game.state.troops += 2000;
                        game.state.gold += 3000;
                        effectMsg = "ä½ ç§°å¸å»ºç«‹èœ€æ±‰ï¼Œè·å¾—2000å…µåŠ›å’Œ3000é‡‘ï¼";
                    } else {
                        game.state.troops += 1500; // å­™æƒè­¦æƒ•
                        effectMsg = "åˆ˜å¤‡ç§°å¸ï¼Œä½ åŠ å¼ºå†›å¤‡ï¼Œè·å¾—1500å…µåŠ›ï¼";
                    }
                    return effectMsg;
                } 
            },
            229: { 
                title: "å­™æƒç§°å¸", 
                message: "å­™æƒåœ¨å»ºä¸šç§°å¸ï¼Œå»ºç«‹ä¸œå´ï¼", 
                effect: (game) => {
                    let effectMsg = "";
                    if (game.character === 'æ›¹æ“') {
                        game.state.troops += 1000; // é­å›½åŠ å¼ºé˜²å¾¡
                        effectMsg = "å­™æƒç§°å¸ï¼Œä½ åŠ å¼ºé˜²å¾¡ï¼Œè·å¾—1000å…µåŠ›ï¼";
                    } else if (game.character === 'åˆ˜å¤‡') {
                        // åˆ˜å¤‡å·²å»ä¸–ï¼Œæ¸¸æˆä¸­çš„ç»§æ‰¿è€…
                        game.state.food += 2000;
                        effectMsg = "å­™æƒç§°å¸ï¼Œä½ åŠ å¼ºç²®è‰å‚¨å¤‡ï¼Œè·å¾—2000ç²®è‰ï¼";
                    } else {
                        game.state.troops += 2500;
                        game.state.gold += 4000;
                        effectMsg = "ä½ ç§°å¸å»ºç«‹ä¸œå´ï¼Œè·å¾—2500å…µåŠ›å’Œ4000é‡‘ï¼";
                    }
                    return effectMsg;
                } 
            },
            234: { 
                title: "è¯¸è‘›äº®ç—…é€", 
                message: "èœ€æ±‰ä¸ç›¸è¯¸è‘›äº®ç—…é€äºäº”ä¸ˆåŸï¼", 
                effect: (game) => {
                    let effectMsg = "";
                    if (game.character === 'æ›¹æ“') {
                        game.state.troops += 1500; // é­å›½å‹åŠ›å‡è½»
                        effectMsg = "è¯¸è‘›äº®ç—…é€ï¼Œèœ€æ±‰å¨èƒå‡è½»ï¼Œè·å¾—1500å…µåŠ›ï¼";
                    } else if (game.character === 'åˆ˜å¤‡') {
                        game.state.troops = Math.floor(game.state.troops * 0.9); // èœ€å›½å£«æ°”ä½è½
                        effectMsg = "è¯¸è‘›äº®ç—…é€ï¼Œèœ€æ±‰å£«æ°”ä½è½ï¼ŒæŸå¤±10%å…µåŠ›ï¼";
                    } else {
                        game.state.food += 2000; // å­™æƒè¶æœºå‘å±•
                        effectMsg = "è¯¸è‘›äº®ç—…é€ï¼Œä½ è¶æœºå‘å±•ï¼Œè·å¾—2000ç²®è‰ï¼";
                    }
                    return effectMsg;
                } 
            },
            249: { 
                title: "é«˜å¹³é™µä¹‹å˜", 
                message: "å¸é©¬æ‡¿å‘åŠ¨æ”¿å˜ï¼Œæ§åˆ¶æ›¹é­æ”¿æƒï¼", 
                effect: (game) => {
                    let effectMsg = "";
                    if (game.character === 'æ›¹æ“') {
                        game.state.troops = Math.floor(game.state.troops * 0.8); // é­å›½å†…ä¹±
                        effectMsg = "å¸é©¬æ‡¿å‘åŠ¨æ”¿å˜ï¼Œé­å›½å†…ä¹±ï¼ŒæŸå¤±20%å…µåŠ›ï¼";
                    } else if (game.character === 'åˆ˜å¤‡') {
                        game.state.troops += 1000; // èœ€å›½å¯èƒ½æœ‰æœºä¼š
                        effectMsg = "é­å›½å†…ä¹±ï¼Œä½ åŠ å¼ºå†›å¤‡ï¼Œè·å¾—1000å…µåŠ›ï¼";
                    } else {
                        game.state.troops += 1500; // å´å›½åŠ å¼ºé˜²å¾¡
                        effectMsg = "é­å›½å†…ä¹±ï¼Œä½ åŠ å¼ºé˜²å¾¡ï¼Œè·å¾—1500å…µåŠ›ï¼";
                    }
                    return effectMsg;
                } 
            },
            263: { 
                title: "èœ€æ±‰ç­äº¡", 
                message: "é‚“è‰¾å·æ¸¡é˜´å¹³ï¼Œèœ€æ±‰ç­äº¡ï¼", 
                effect: (game) => {
                    let effectMsg = "";
                    if (game.character === 'æ›¹æ“') {
                        game.state.troops += 3000; // é­å›½ç­èœ€
                        game.state.gold += 5000;
                        effectMsg = "ä½ çš„ç»§æ‰¿è€…ç­èœ€ï¼Œè·å¾—3000å…µåŠ›å’Œ5000é‡‘ï¼";
                    } else if (game.character === 'åˆ˜å¤‡') {
                        // æ¸¸æˆç»“æŸ
                        game.state.troops = 0;
                        effectMsg = "ä½ çš„å›½å®¶ç­äº¡äº†ï¼";
                        setTimeout(() => {
                            alert("èœ€æ±‰ç­äº¡ï¼Œæ¸¸æˆç»“æŸï¼");
                            game.returnToCharacterSelection();
                        }, 3000);
                    } else {
                        game.state.troops += 2000; // å´å›½é¢ä¸´æ›´å¤§å‹åŠ›
                        effectMsg = "èœ€æ±‰ç­äº¡ï¼Œä½ åŠ å¼ºé˜²å¾¡ï¼Œè·å¾—2000å…µåŠ›ï¼";
                    }
                    return effectMsg;
                } 
            },
            280: { 
                title: "ä¸‰å›½å½’æ™‹", 
                message: "æ™‹ç­ä¸œå´ï¼Œä¸‰å›½æ—¶ä»£ç»“æŸï¼", 
                effect: (game) => {
                    let effectMsg = "";
                    if (game.character === 'æ›¹æ“') {
                        // é­å›½å·²è¢«æ™‹å–ä»£
                        effectMsg = "ä¸‰å›½å½’æ™‹ï¼Œé­å›½å·²è¢«æ™‹å–ä»£ï¼";
                    } else if (game.character === 'åˆ˜å¤‡') {
                        // èœ€æ±‰å·²ç­äº¡
                        effectMsg = "ä¸‰å›½å½’æ™‹ï¼Œèœ€æ±‰æ—©å·²ç­äº¡ï¼";
                    } else {
                        // å´å›½ç­äº¡
                        effectMsg = "ä¸‰å›½å½’æ™‹ï¼Œä¸œå´ç­äº¡ï¼";
                        setTimeout(() => {
                            alert("ä¸œå´ç­äº¡ï¼Œæ¸¸æˆç»“æŸï¼");
                            game.returnToCharacterSelection();
                        }, 3000);
                    }
                    return effectMsg;
                } 
            }
        };

        // é—®é¢˜åº“é…ç½® - å¢åŠ åˆ°40é¢˜
        const QUESTIONS = [
            { 
                q: "å®˜æ¸¡ä¹‹æˆ˜çš„ä¸»è¦äº¤æˆ˜åŒæ–¹æ˜¯ï¼Ÿ", 
                o: ["æ›¹æ“vsè¢ç»", "åˆ˜å¤‡vså­™æƒ", "æ›¹æ“vsåˆ˜å¤‡"], 
                a: 0,
                hint: "è¿™åœºæˆ˜å½¹å‘ç”Ÿåœ¨å…¬å…ƒ200å¹´ï¼Œæ˜¯åŒ—æ–¹ä¸¤å¤§åŠ¿åŠ›çš„å†³æˆ˜ã€‚"
            },
            { 
                q: "è¯¸è‘›äº®çš„å­—æ˜¯ä»€ä¹ˆï¼Ÿ", 
                o: ["å­”æ˜", "ä»²è¾¾", "å…¬ç‘¾"], 
                a: 0,
                hint: "ä»–çš„å­—ä¸'å§é¾™'çš„ç§°å·ç›¸å‘¼åº”ï¼Œæ„ä¸º'æ˜äº®çš„å­”æ´'ã€‚"
            },
            { 
                q: "æ¡ƒå›­ä¸‰ç»“ä¹‰çš„ä¸‰ä¸ªäººæ˜¯ï¼Ÿ", 
                o: ["åˆ˜å¤‡ã€å…³ç¾½ã€å¼ é£", "æ›¹æ“ã€å­™æƒã€åˆ˜å¤‡", "å•å¸ƒã€è²‚è‰ã€è‘£å“"], 
                a: 0,
                hint: "è¿™ä¸‰äººåœ¨æ¡ƒå›­ç»“ä¸ºå¼‚å§“å…„å¼Ÿï¼Œèª“åŒç”Ÿæ­»ã€‚"
            },
            { 
                q: "èµ¤å£ä¹‹æˆ˜å‘ç”Ÿåœ¨å“ªä¸ªæ±Ÿï¼Ÿ", 
                o: ["é•¿æ±Ÿ", "é»„æ²³", "æ·®æ²³"], 
                a: 0,
                hint: "è¿™æ˜¯ä¸­å›½æœ€é•¿çš„æ²³æµï¼Œä¹Ÿæ˜¯å—åŒ—åˆ†ç•Œçº¿ã€‚"
            },
            { 
                q: "å­™æƒæ˜¯å“ªä¸ªå›½å®¶çš„ä¸»å…¬ï¼Ÿ", 
                o: ["å´å›½", "é­å›½", "èœ€å›½"], 
                a: 0,
                hint: "è¿™ä¸ªå›½å®¶ä½äºä¸œå—æ²¿æµ·ï¼Œä»¥æ°´å†›è‘—ç§°ã€‚"
            },
            { 
                q: "è¢«ç§°ä¸ºå°éœ¸ç‹çš„æ˜¯è°ï¼Ÿ", 
                o: ["å­™ç­–", "å­™åš", "å‘¨ç‘œ"], 
                a: 0,
                hint: "ä»–æ˜¯å­™æƒçš„å…„é•¿ï¼Œå‹‡çŒ›å–„æˆ˜ï¼Œå¥ å®šäº†å´å›½çš„åŸºç¡€ã€‚"
            },
            { 
                q: "å…³ç¾½è¿‡äº”å…³æ–©çš„ç¬¬ä¸€å°†æ˜¯è°ï¼Ÿ", 
                o: ["å­”ç§€", "éŸ©ç¦", "å­Ÿå¦"], 
                a: 0,
                hint: "è¿™ä½å°†é¢†é•‡å®ˆä¸œå²­å…³ï¼Œæ˜¯å…³ç¾½åŒ—ä¸Šçš„ç¬¬ä¸€é“å…³å¡ã€‚"
            },
            { 
                q: "ä»¥ä¸‹è°æ˜¯åˆ˜ç¦…çš„ä¹³åï¼Ÿ", 
                o: ["é˜¿æ–—", "ä¼¯çº¦", "å¥‰å­"], 
                a: 0,
                hint: "è¿™ä¸ªä¹³åå› 'æ‰¶ä¸èµ·çš„...'è€Œé—»åã€‚"
            },
            { 
                q: "å“ªä¸ªå›½å®¶æ˜¯ç”±æ›¹ä¸•å»ºç«‹çš„ï¼Ÿ", 
                o: ["é­å›½", "èœ€å›½", "å´å›½"], 
                a: 0,
                hint: "è¿™ä¸ªå›½å®¶ä½äºåŒ—æ–¹ï¼Œä»¥æ´›é˜³ä¸ºéƒ½åŸã€‚"
            },
            { 
                q: "åˆ˜å¤‡ä¸‰é¡¾èŒ…åºè¯·çš„æ˜¯è°ï¼Ÿ", 
                o: ["è¯¸è‘›äº®", "åºç»Ÿ", "å¾åº¶"], 
                a: 0,
                hint: "è¿™ä½è°‹å£«åæ¥æˆä¸ºèœ€æ±‰çš„ä¸ç›¸ï¼Œè¢«èª‰ä¸º'å§é¾™'ã€‚"
            },
            { 
                q: "ä¸‰å›½æ—¶æœŸè‘—åçš„'ä¸ƒæ“’å­Ÿè·'æ˜¯è°çš„åŠŸç»©ï¼Ÿ", 
                o: ["è¯¸è‘›äº®", "å…³ç¾½", "èµµäº‘"], 
                a: 0,
                hint: "è¿™ä½èœ€æ±‰ä¸ç›¸ä»¥æ™ºæ…§å’Œè°‹ç•¥é—»åã€‚"
            },
            { 
                q: "è°è¢«ç§°ä¸º'ç¾é«¯å…¬'ï¼Ÿ", 
                o: ["å…³ç¾½", "å¼ é£", "å•å¸ƒ"], 
                a: 0,
                hint: "è¿™ä½æ­¦å°†æœ‰ä¸€æŠŠæ¼‚äº®çš„é•¿é¡»ã€‚"
            },
            { 
                q: "è°åœ¨é•¿å‚å¡å•éª‘æ•‘é˜¿æ–—ï¼Ÿ", 
                o: ["èµµäº‘", "å…³ç¾½", "å¼ é£"], 
                a: 0,
                hint: "è¿™ä½æ­¦å°†ä»¥å‹‡çŒ›å’Œå¿ è¯šè‘—ç§°ã€‚"
            },
            { 
                q: "è°æå‡ºäº†'ä¸‰åˆ†å¤©ä¸‹'çš„æˆ˜ç•¥ï¼Ÿ", 
                o: ["è¯¸è‘›äº®", "å‘¨ç‘œ", "å¸é©¬æ‡¿"], 
                a: 0,
                hint: "è¿™ä½è°‹å£«åœ¨éš†ä¸­å¯¹ä¸­æå‡ºäº†è¿™ä¸€æˆ˜ç•¥ã€‚"
            },
            { 
                q: "è°åœ¨èµ¤å£ä¹‹æˆ˜ä¸­ä½¿ç”¨äº†ç«æ”»ï¼Ÿ", 
                o: ["å‘¨ç‘œ", "è¯¸è‘›äº®", "æ›¹æ“"], 
                a: 0,
                hint: "è¿™ä½å´å›½éƒ½ç£æ˜¯èµ¤å£ä¹‹æˆ˜çš„ä¸»è¦æŒ‡æŒ¥å®˜ã€‚"
            },
            { 
                q: "è°è¢«ç§°ä¸º'å‡¤é›'ï¼Ÿ", 
                o: ["åºç»Ÿ", "è¯¸è‘›äº®", "å¾åº¶"], 
                a: 0,
                hint: "è¿™ä½è°‹å£«ä¸'å§é¾™'é½åã€‚"
            },
            { 
                q: "è°åœ¨å®šå†›å±±æ–©æ€äº†å¤ä¾¯æ¸Šï¼Ÿ", 
                o: ["é»„å¿ ", "å…³ç¾½", "å¼ é£"], 
                a: 0,
                hint: "è¿™ä½è€å°†åœ¨æ­¤æˆ˜ä¸­è¡¨ç°å‡ºè‰²ã€‚"
            },
            { 
                q: "è°åœ¨åˆè‚¥ä¹‹æˆ˜ä¸­ä»¥å…«ç™¾ç ´åä¸‡ï¼Ÿ", 
                o: ["å¼ è¾½", "è®¸è¤š", "å…¸éŸ¦"], 
                a: 0,
                hint: "è¿™ä½é­å›½å°†é¢†ä»¥å‹‡çŒ›è‘—ç§°ã€‚"
            },
            { 
                q: "è°åœ¨å¤·é™µä¹‹æˆ˜ä¸­å¤§è´¥åˆ˜å¤‡ï¼Ÿ", 
                o: ["é™†é€Š", "å‘¨ç‘œ", "å•è’™"], 
                a: 0,
                hint: "è¿™ä½å´å›½å°†é¢†ä½¿ç”¨äº†ç«æ”»æˆ˜æœ¯ã€‚"
            },
            { 
                q: "è°åœ¨éº¦åŸè¢«æ“’åé‡å®³ï¼Ÿ", 
                o: ["å…³ç¾½", "å¼ é£", "èµµäº‘"], 
                a: 0,
                hint: "è¿™ä½èœ€æ±‰åå°†è¢«ä¸œå´æ“’è·ã€‚"
            },
            { 
                q: "è°åœ¨è¡—äº­ä¹‹æˆ˜ä¸­å› å¤±å®ˆè€Œè¢«è¯¸è‘›äº®æ–©é¦–ï¼Ÿ", 
                o: ["é©¬è°¡", "é­å»¶", "å§œç»´"], 
                a: 0,
                hint: "è¿™ä½å°†é¢†è¿èƒŒäº†è¯¸è‘›äº®çš„éƒ¨ç½²ã€‚"
            },
            { 
                q: "è°åœ¨äº”ä¸ˆåŸç—…é€ï¼Ÿ", 
                o: ["è¯¸è‘›äº®", "å¸é©¬æ‡¿", "æ›¹æ“"], 
                a: 0,
                hint: "è¿™ä½èœ€æ±‰ä¸ç›¸åŒ—ä¼æ—¶åœ¨æ­¤å»ä¸–ã€‚"
            },
            { 
                q: "è°åœ¨æ›¹æ“é¢å‰'ç…®é…’è®ºè‹±é›„'ï¼Ÿ", 
                o: ["åˆ˜å¤‡", "å…³ç¾½", "å¼ é£"], 
                a: 0,
                hint: "è¿™ä½èœ€æ±‰å¼€å›½çš‡å¸å½“æ—¶å¯„äººç¯±ä¸‹ã€‚"
            },
            { 
                q: "è°åœ¨é•¿å‚æ¡¥å–é€€æ›¹å†›ï¼Ÿ", 
                o: ["å¼ é£", "å…³ç¾½", "èµµäº‘"], 
                a: 0,
                hint: "è¿™ä½æ­¦å°†ä»¥å‹‡çŒ›å’Œå—“é—¨å¤§è‘—ç§°ã€‚"
            },
            { 
                q: "è°åœ¨æ›¹æ“å†›ä¸­è¢«ç§°ä¸º'è™ç—´'ï¼Ÿ", 
                o: ["è®¸è¤š", "å…¸éŸ¦", "å¼ è¾½"], 
                a: 0,
                hint: "è¿™ä½æ­¦å°†åŠ›å¤§æ— æ¯”ï¼Œå¿ å¿ƒæŠ¤ä¸»ã€‚"
            },
            { 
                q: "è°åœ¨å®›åŸä¹‹æˆ˜ä¸­ä¸ºä¿æŠ¤æ›¹æ“è€Œæˆ˜æ­»ï¼Ÿ", 
                o: ["å…¸éŸ¦", "è®¸è¤š", "å¤ä¾¯æƒ‡"], 
                a: 0,
                hint: "è¿™ä½æ­¦å°†æ‰‹æŒåŒæˆŸï¼Œå‹‡çŒ›æ— æ¯”ã€‚"
            },
            { 
                q: "è°åœ¨æ›¹æ“é¢å‰'å‰²å‘ä»£é¦–'ï¼Ÿ", 
                o: ["æ›¹æ“", "åˆ˜å¤‡", "å­™æƒ"], 
                a: 0,
                hint: "è¿™ä½å›ä¸»ä¸ºäº†ä¸¥æ˜å†›çºªè€Œæƒ©ç½šè‡ªå·±ã€‚"
            },
            { 
                q: "è°åœ¨æ›¹æ“å†›ä¸­è¢«ç§°ä¸º'å¤ä¹‹æ¶æ¥'ï¼Ÿ", 
                o: ["å…¸éŸ¦", "è®¸è¤š", "å¤ä¾¯æƒ‡"], 
                a: 0,
                hint: "è¿™ä½æ­¦å°†åŠ›å¤§æ— æ¯”ï¼Œå¿ å¿ƒæŠ¤ä¸»ã€‚"
            },
            { 
                q: "è°åœ¨æ›¹æ“é¢å‰'æœ›æ¢…æ­¢æ¸´'ï¼Ÿ", 
                o: ["æ›¹æ“", "åˆ˜å¤‡", "å­™æƒ"], 
                a: 0,
                hint: "è¿™ä½å›ä¸»ç”¨è®¡è°‹æ¿€åŠ±å£«å…µå‰è¿›ã€‚"
            },
            { 
                q: "è°åœ¨æ›¹æ“é¢å‰'æŒŸå¤©å­ä»¥ä»¤è¯¸ä¾¯'ï¼Ÿ", 
                o: ["æ›¹æ“", "åˆ˜å¤‡", "è¢ç»"], 
                a: 0,
                hint: "è¿™ä½å›ä¸»æ§åˆ¶äº†æ±‰çŒ®å¸ã€‚"
            },
            { 
                q: "è°åœ¨æ›¹æ“é¢å‰'å®æ•™æˆ‘è´Ÿå¤©ä¸‹äººï¼Œä¼‘æ•™å¤©ä¸‹äººè´Ÿæˆ‘'ï¼Ÿ", 
                o: ["æ›¹æ“", "åˆ˜å¤‡", "å­™æƒ"], 
                a: 0,
                hint: "è¿™å¥è¯ä½“ç°äº†è¿™ä½å›ä¸»çš„æ€§æ ¼ã€‚"
            },
            { 
                q: "è°åœ¨æ›¹æ“é¢å‰'æ²»ä¸–ä¹‹èƒ½è‡£ï¼Œä¹±ä¸–ä¹‹å¥¸é›„'ï¼Ÿ", 
                o: ["æ›¹æ“", "åˆ˜å¤‡", "è¢ç»"], 
                a: 0,
                hint: "è¿™æ˜¯è®¸åŠ­å¯¹è¿™ä½å›ä¸»çš„è¯„ä»·ã€‚"
            },
            { 
                q: "è°åœ¨åˆ˜å¤‡é¢å‰'å‹¿ä»¥æ¶å°è€Œä¸ºä¹‹ï¼Œå‹¿ä»¥å–„å°è€Œä¸ä¸º'ï¼Ÿ", 
                o: ["åˆ˜å¤‡", "æ›¹æ“", "å­™æƒ"], 
                a: 0,
                hint: "è¿™æ˜¯è¿™ä½å›ä¸»ä¸´ç»ˆå‰å¯¹å„¿å­çš„æ•™è¯²ã€‚"
            },
            { 
                q: "è°åœ¨åˆ˜å¤‡é¢å‰'å…„å¼Ÿå¦‚æ‰‹è¶³ï¼Œå¦»å­å¦‚è¡£æœ'ï¼Ÿ", 
                o: ["åˆ˜å¤‡", "å…³ç¾½", "å¼ é£"], 
                a: 0,
                hint: "è¿™å¥è¯ä½“ç°äº†è¿™ä½å›ä¸»å¯¹å…„å¼Ÿæƒ…çš„é‡è§†ã€‚"
            },
            { 
                q: "è°åœ¨å­™æƒé¢å‰'ç”Ÿå­å½“å¦‚å­™ä»²è°‹'ï¼Ÿ", 
                o: ["æ›¹æ“", "åˆ˜å¤‡", "è¢ç»"], 
                a: 0,
                hint: "è¿™æ˜¯è¿™ä½å›ä¸»å¯¹å­™æƒçš„è¯„ä»·ã€‚"
            },
            { 
                q: "è°åœ¨å­™æƒé¢å‰'èƒ½ç”¨ä¼—åŠ›ï¼Œåˆ™æ— æ•Œäºå¤©ä¸‹çŸ£'ï¼Ÿ", 
                o: ["å­™æƒ", "æ›¹æ“", "åˆ˜å¤‡"], 
                a: 0,
                hint: "è¿™å¥è¯ä½“ç°äº†è¿™ä½å›ä¸»çš„ç”¨äººç†å¿µã€‚"
            },
            { 
                q: "è°åœ¨å­™æƒé¢å‰'å£«åˆ«ä¸‰æ—¥ï¼Œå½“åˆ®ç›®ç›¸å¾…'ï¼Ÿ", 
                o: ["å•è’™", "é™†é€Š", "å‘¨ç‘œ"], 
                a: 0,
                hint: "è¿™ä½å°†é¢†é€šè¿‡å­¦ä¹ æ”¹å˜äº†é²è‚ƒçš„çœ‹æ³•ã€‚"
            },
            { 
                q: "è°åœ¨å­™æƒé¢å‰'ç™½è¡£æ¸¡æ±Ÿ'å·è¢­è†å·ï¼Ÿ", 
                o: ["å•è’™", "é™†é€Š", "å‘¨ç‘œ"], 
                a: 0,
                hint: "è¿™ä½å°†é¢†ä¼ªè£…æˆå•†äººæˆåŠŸå·è¢­ã€‚"
            },
            { 
                q: "è°åœ¨å­™æƒé¢å‰'ç«çƒ§è¿è¥'å‡»è´¥åˆ˜å¤‡ï¼Ÿ", 
                o: ["é™†é€Š", "å‘¨ç‘œ", "å•è’™"], 
                a: 0,
                hint: "è¿™ä½å°†é¢†åœ¨å¤·é™µä¹‹æˆ˜ä¸­ä½¿ç”¨äº†ç«æ”»ã€‚"
            },
            { 
                q: "è°åœ¨å­™æƒé¢å‰'æ—¢ç”Ÿç‘œï¼Œä½•ç”Ÿäº®'ï¼Ÿ", 
                o: ["å‘¨ç‘œ", "å•è’™", "é™†é€Š"], 
                a: 0,
                hint: "è¿™ä½å´å›½éƒ½ç£ä¸´ç»ˆå‰çš„æ„Ÿå¹ã€‚"
            }
        ];

        // åŸæ± é…ç½® - å¢åŠ åˆ°14åº§åŸæ± 
        const CITIES = [
            { name: 'æ´›é˜³', x: 55, y: 35, defender: 'è‘£å“', troops: 4000 },   // ä¸­åŸåœ°åŒº
            { name: 'æˆéƒ½', x: 20, y: 70, defender: 'åˆ˜ç’‹', troops: 3500 },   // è¥¿å—èœ€åœ°
            { name: 'è®¸æ˜Œ', x: 60, y: 40, defender: 'å¼ æµ', troops: 3800 },   // ä¸­åŸåœ°åŒº
            { name: 'å»ºä¸š', x: 75, y: 30, defender: 'åˆ˜ç¹‡', troops: 3700 },   // ä¸œå—å´åœ°
            { name: 'é•¿å®‰', x: 35, y: 45, defender: 'æå‚•', troops: 4200 },   // è¥¿åŒ—åœ°åŒº
            { name: 'è†å·', x: 50, y: 55, defender: 'åˆ˜è¡¨', troops: 3600 },   // é•¿æ±Ÿä¸­æ¸¸
            { name: 'å¾å·', x: 65, y: 40, defender: 'é™¶è°¦', troops: 3400 },   // ä¸œéƒ¨åœ°åŒº
            { name: 'è¥„é˜³', x: 45, y: 50, defender: 'è”¡ç‘', troops: 3900 },   // è†å·åŒ—éƒ¨
            { name: 'å®›åŸ', x: 50, y: 40, defender: 'å¼ ç»£', troops: 3300 },   // å—é˜³åœ°åŒº
            { name: 'å—éƒ¡', x: 45, y: 60, defender: 'æ›¹ä»', troops: 4100 },    // è†å·å—éƒ¨
            { name: 'æ±‰ä¸­', x: 30, y: 50, defender: 'å¼ é²', troops: 3800 },    // æ–°å¢åŸæ± 
            { name: 'æ±Ÿå¤', x: 55, y: 60, defender: 'é»„ç¥–', troops: 3500 },    // æ–°å¢åŸæ± 
            { name: 'åˆè‚¥', x: 70, y: 45, defender: 'å¼ è¾½', troops: 4200 },    // æ–°å¢åŸæ± 
            { name: 'é‚ºåŸ', x: 60, y: 30, defender: 'è¢ç»', troops: 4500 }     // æ–°å¢åŸæ± 
        ];

        // éšæœºäº‹ä»¶é…ç½®
        const RANDOM_EVENTS = [
            // æ­£é¢äº‹ä»¶
            {
                title: "ä¸°æ”¶ä¹‹å¹´",
                message: "ä»Šå¹´é£è°ƒé›¨é¡ºï¼Œå†œç”°å¤§ä¸°æ”¶ï¼",
                effect: (game) => {
                    const bonus = Math.floor(Math.random() * 3000) + 2000;
                    game.state.food += bonus;
                    return `è·å¾—${bonus}ç²®è‰ï¼`;
                },
                probability: 0.15
            },
            {
                title: "å‘ç°å®è—",
                message: "åœ¨ä½ çš„é¢†åœ°å†…å‘ç°äº†ä¸€å¤„éšè—çš„å®è—ï¼",
                effect: (game) => {
                    const bonus = Math.floor(Math.random() * 2000) + 1000;
                    game.state.gold += bonus;
                    return `è·å¾—${bonus}é‡‘ï¼`;
                },
                probability: 0.1
            },
            {
                title: "åå°†æ¥æŠ•",
                message: "ä¸€ä½è‘—åå°†é¢†ä»°æ…•ä½ çš„å¨åï¼Œç‡éƒ¨æ¥æŠ•ï¼",
                effect: (game) => {
                    const bonus = Math.floor(Math.random() * 800) + 500;
                    game.state.troops += bonus;
                    return `è·å¾—${bonus}å…µåŠ›ï¼`;
                },
                probability: 0.1
            },
            {
                title: "å•†é˜Ÿè´¸æ˜“",
                message: "ä¸€æ”¯å¤§å‹å•†é˜Ÿæ¥åˆ°ä½ çš„åŸæ± è¿›è¡Œè´¸æ˜“ï¼Œå¸¦æ¥äº†ä¸°åšåˆ©æ¶¦ï¼",
                effect: (game) => {
                    const goldBonus = Math.floor(Math.random() * 1500) + 1000;
                    const foodBonus = Math.floor(Math.random() * 2000) + 1000;
                    game.state.gold += goldBonus;
                    game.state.food += foodBonus;
                    return `è·å¾—${goldBonus}é‡‘å’Œ${foodBonus}ç²®è‰ï¼`;
                },
                probability: 0.1
            },
            {
                title: "æ°‘å¿ƒæ‰€å‘",
                message: "ä½ çš„ä»æ”¿æ·±å¾—æ°‘å¿ƒï¼Œç™¾å§“è¸Šè·ƒå‚å†›ï¼",
                effect: (game) => {
                    const troopsBonus = Math.floor(Math.random() * 1000) + 500;
                    game.state.troops += troopsBonus;
                    return `è·å¾—${troopsBonus}å…µåŠ›ï¼`;
                },
                probability: 0.08
            },
            // è´Ÿé¢äº‹ä»¶
            {
                title: "è—ç¾è‚†è™",
                message: "å¯æ€•çš„è—ç¾å¸­å·äº†ä½ çš„é¢†åœ°ï¼",
                effect: (game) => {
                    const loss = Math.floor(Math.random() * 3000) + 2000;
                    game.state.food = Math.max(0, game.state.food - loss);
                    return `æŸå¤±${loss}ç²®è‰ï¼`;
                },
                probability: 0.1
            },
            {
                title: "æ•Œå†›å·è¢­",
                message: "æ•Œå†›è¶å¤œå·è¢­äº†ä½ çš„è¥åœ°ï¼",
                effect: (game) => {
                    const loss = Math.floor(Math.random() * 800) + 500;
                    game.state.troops = Math.max(0, game.state.troops - loss);
                    return `æŸå¤±${loss}å…µåŠ›ï¼`;
                },
                probability: 0.1
            },
            {
                title: "å›½åº“å¤±çªƒ",
                message: "æœ‰ç›—è´¼æ½œå…¥å›½åº“ï¼Œå·èµ°äº†å¤§é‡é’±è´¢ï¼",
                effect: (game) => {
                    const loss = Math.floor(Math.random() * 2000) + 1000;
                    game.state.gold = Math.max(0, game.state.gold - loss);
                    return `æŸå¤±${loss}é‡‘ï¼`;
                },
                probability: 0.08
            },
            {
                title: "ç˜Ÿç–«æµè¡Œ",
                message: "é¢†åœ°å†…çˆ†å‘ç˜Ÿç–«ï¼Œå†›æ°‘å£«æ°”ä½è½ï¼",
                effect: (game) => {
                    const troopsLoss = Math.floor(Math.random() * 1000) + 500;
                    const foodLoss = Math.floor(Math.random() * 2000) + 1000;
                    game.state.troops = Math.max(0, game.state.troops - troopsLoss);
                    game.state.food = Math.max(0, game.state.food - foodLoss);
                    return `æŸå¤±${troopsLoss}å…µåŠ›å’Œ${foodLoss}ç²®è‰ï¼`;
                },
                probability: 0.07
            },
            {
                title: "å¹²æ—±ç¼ºæ°´",
                message: "æŒç»­å¹²æ—±å¯¼è‡´å†œç”°æ­‰æ”¶ï¼Œæ°´æºçŸ­ç¼ºï¼",
                effect: (game) => {
                    const loss = Math.floor(Math.random() * 4000) + 2000;
                    game.state.food = Math.max(0, game.state.food - loss);
                    return `æŸå¤±${loss}ç²®è‰ï¼`;
                },
                probability: 0.07
            },
            // ä¸­æ€§äº‹ä»¶
            {
                title: "ç¥ç§˜å•†äºº",
                message: "ä¸€ä½ç¥ç§˜å•†äººæ¥åˆ°ä½ çš„åŸæ± ï¼Œæ„¿æ„ä»¥ä¼˜æƒ ä»·æ ¼å‡ºå”®å•†å“ï¼",
                effect: (game) => {
                    // éšæœºé€‰æ‹©ä¸€ç§å•†å“æ‰“æŠ˜å‡ºå”®
                    const items = ['troops', 'food', 'freeAnswer', 'doubleReward'];
                    const item = items[Math.floor(Math.random() * items.length)];
                    const discount = Math.floor(Math.random() * 30) + 20; // 20-50%æŠ˜æ‰£
                    
                    let cost = 0;
                    let bonus = 0;
                    let itemName = '';
                    
                    switch(item) {
                        case 'troops':
                            cost = Math.floor(3000 * (100 - discount) / 100);
                            bonus = 1000;
                            itemName = 'å…µåŠ›è¡¥å……åŒ…';
                            break;
                        case 'food':
                            cost = Math.floor(2000 * (100 - discount) / 100);
                            bonus = 5000;
                            itemName = 'ç²®è‰è¡¥å……åŒ…';
                            break;
                        case 'freeAnswer':
                            cost = Math.floor(2500 * (100 - discount) / 100);
                            bonus = 1;
                            itemName = 'å…ç­”å¡';
                            break;
                        case 'doubleReward':
                            cost = Math.floor(4000 * (100 - discount) / 100);
                            bonus = 1;
                            itemName = 'åŒå€å¥–åŠ±å¡';
                            break;
                    }
                    
                    const buy = confirm(`ç¥ç§˜å•†äººæ„¿æ„ä»¥${discount}%æŠ˜æ‰£å‡ºå”®${itemName}ï¼Œåªéœ€${cost}é‡‘ã€‚æ˜¯å¦è´­ä¹°ï¼Ÿ`);
                    if (buy && game.state.gold >= cost) {
                        game.state.gold -= cost;
                        if (item === 'troops') game.state.troops += bonus;
                        else if (item === 'food') game.state.food += bonus;
                        else game.state.items[item] += bonus;
                        game.updateDisplay();
                        return `ä½ è´­ä¹°äº†${itemName}ï¼`;
                    } else if (buy) {
                        return `èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•è´­ä¹°${itemName}ã€‚`;
                    } else {
                        return `ä½ æ‹’ç»äº†ç¥ç§˜å•†äººçš„æè®®ã€‚`;
                    }
                },
                probability: 0.05
            },
            {
                title: "å¤©é™å¼‚è±¡",
                message: "å¤©ç©ºå‡ºç°å¥‡å¼‚å¤©è±¡ï¼Œç™¾å§“è®®è®ºçº·çº·ï¼",
                effect: (game) => {
                    // 50%å‡ ç‡æ­£é¢æ•ˆæœï¼Œ50%è´Ÿé¢æ•ˆæœ
                    if (Math.random() > 0.5) {
                        const bonus = Math.floor(Math.random() * 1000) + 500;
                        game.state.troops += bonus;
                        return `å£«å…µä»¬è®¤ä¸ºè¿™æ˜¯å‰å…†ï¼Œå£«æ°”å¤§æŒ¯ï¼è·å¾—${bonus}å…µåŠ›ï¼`;
                    } else {
                        const loss = Math.floor(Math.random() * 1000) + 500;
                        game.state.troops = Math.max(0, game.state.troops - loss);
                        return `å£«å…µä»¬è®¤ä¸ºè¿™æ˜¯å‡¶å…†ï¼Œå£«æ°”ä½è½ï¼æŸå¤±${loss}å…µåŠ›ï¼`;
                    }
                },
                probability: 0.05
            },
            // æ–°å¢çš„åŸæ± è¢«æ”»æ‰“äº‹ä»¶
            {
                title: "æ•Œå†›æ¥çŠ¯",
                message: "æ•Œå†›æ­£åœ¨æ”»æ‰“ä½ çš„åŸæ± ï¼",
                effect: (game) => {
                    if (game.state.cities.length === 0) {
                        return "ä½ æ²¡æœ‰åŸæ± å¯è¢«æ”»æ‰“ï¼";
                    }
                    
                    // éšæœºé€‰æ‹©ä¸€ä¸ªè¢«æ”»æ‰“çš„åŸæ± 
                    const cityIndex = Math.floor(Math.random() * game.state.cities.length);
                    const cityName = game.state.cities[cityIndex];
                    const city = CITIES.find(c => c.name === cityName);
                    
                    // æ˜¾ç¤ºç¡®è®¤æ¡†ï¼Œè®©ç©å®¶é€‰æ‹©æ˜¯å¦å›é˜²
                    const defend = confirm(`æ•Œå†›æ­£åœ¨æ”»æ‰“${cityName}ï¼æ˜¯å¦ç«‹å³å›é˜²ï¼Ÿ\n(å–æ¶ˆåˆ™è‡ªåŠ¨é˜²å®ˆï¼ŒæˆåŠŸç‡è¾ƒä½)`);
                    
                    if (defend) {
                        // ç©å®¶é€‰æ‹©å›é˜²ï¼Œéœ€è¦å›ç­”é—®é¢˜é˜²å®ˆ
                        game.defendCity(city);
                        return `ä½ å·²é€‰æ‹©å›é˜²${cityName}ï¼`;
                    } else {
                        // è‡ªåŠ¨é˜²å®ˆï¼ŒæˆåŠŸç‡è¾ƒä½
                        const success = Math.random() < 0.3; // 30%æˆåŠŸç‡
                        
                        if (success) {
                            return `å®ˆå†›æˆåŠŸå‡»é€€äº†è¿›æ”»${cityName}çš„æ•Œå†›ï¼`;
                        } else {
                            // é˜²å®ˆå¤±è´¥ï¼Œå¤±å»åŸæ± 
                            game.state.cities.splice(cityIndex, 1);
                            game.initMap();
                            game.updateDisplay();
                            return `é˜²å®ˆå¤±è´¥ï¼Œ${cityName}è¢«æ•Œå†›æ”»å ï¼`;
                        }
                    }
                },
                probability: 0.8 // 80%æ¦‚ç‡å‘ç”Ÿ
            }
        ];

        // éŸ³ä¹æ§åˆ¶å‡½æ•°
        function toggleMusic() {
            const music = document.getElementById('bgMusic');
            const icon = document.getElementById('musicIcon');
            
            if (music.paused) {
                music.play();
                icon.textContent = 'ğŸ”Š';
            } else {
                music.pause();
                icon.textContent = 'ğŸ”‡';
            }
        }

        class ThreeKingdomsGame {
            constructor(character) {
                this.character = character;
                this.state = {
                    gold: character === 'æ›¹æ“' ? 6000 : character === 'åˆ˜å¤‡' ? 5000 : 5500,
                    food: character === 'æ›¹æ“' ? 12000 : character === 'åˆ˜å¤‡' ? 10000 : 11000,
                    troops: character === 'æ›¹æ“' ? 3500 : character === 'åˆ˜å¤‡' ? 3000 : 3200,
                    cities: [],
                    items: {
                        freeAnswer: 0,
                        doubleReward: 0
                    },
                    alliance: {
                        active: false,
                        city: null,
                        conqueredSinceAlliance: 0
                    },
                    reputation: 50 // åˆå§‹å£°æœ›å€¼
                };
                this.currentYear = 184; // åˆå§‹å¹´ä»½è®¾ä¸º184å¹´(é»„å·¾èµ·ä¹‰)
                this.yearInterval = null; // å¹´ä»½è®¡æ—¶å™¨
                this.currentCity = null;
                this.correctAnswers = 0;
                this.requiredAnswers = 2; // é»˜è®¤éœ€è¦ç­”å¯¹2é¢˜
                this.currentQuestion = null;
                this.stats = {
                    correct: 0,
                    wrong: 0,
                    history: [],
                    currentStreak: 0,
                    maxStreak: 0
                };
                this.lastEventTime = 0;
                this.agricultureLevel = 0;
                this.agricultureInterval = null;
                this.resourceQuestion = null;
                this.resourceCorrectAnswers = 0;
                this.resourceRequiredAnswers = 3;
                this.isAnswering = false;
                this.allianceCooldown = false; // ç»“ç›Ÿå†·å´çŠ¶æ€
                this.allianceCooldownTimeout = null; // ç»“ç›Ÿå†·å´è®¡æ—¶å™¨
                this.currentDialogue = null; // å½“å‰å¯¹è¯
                this.dialogueIndex = 0; // å¯¹è¯ç´¢å¼•
                
                this.initMap();
                this.updateDisplay();
                this.startYearTimer(); // å¯åŠ¨å¹´ä»½è®¡æ—¶å™¨
                
                // è‡ªåŠ¨æ’­æ”¾èƒŒæ™¯éŸ³ä¹
                document.getElementById('bgMusic').volume = 0.3;
                document.getElementById('bgMusic').play();
                document.getElementById('musicIcon').textContent = 'ğŸ”Š';
                
                // è®¾ç½®éšæœºäº‹ä»¶æ£€æŸ¥å®šæ—¶å™¨
                this.eventCheckInterval = setInterval(() => this.checkForRandomEvent(), 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
                
                // æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºèµ„æºè·å–æŒ‰é’®
                this.checkResourceButton();
            }

            // å¯åŠ¨å¹´ä»½è®¡æ—¶å™¨
            startYearTimer() {
                document.getElementById('yearDisplay').style.display = 'block';
                this.updateYearDisplay();
                
                // æ¯30ç§’å¢åŠ ä¸€å¹´
                this.yearInterval = setInterval(() => {
                    this.currentYear++;
                    this.updateYearDisplay();
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰å†å²äº‹ä»¶
                    if (HISTORICAL_EVENTS[this.currentYear]) {
                        this.triggerHistoricalEvent(HISTORICAL_EVENTS[this.currentYear]);
                    }
                    
                    // å¦‚æœåˆ°è¾¾280å¹´(ä¸‰å›½å½’æ™‹)ï¼Œæ¸¸æˆç»“æŸ
                    if (this.currentYear >= 280) {
                        clearInterval(this.yearInterval);
                        setTimeout(() => {
                            alert("ä¸‰å›½æ—¶ä»£ç»“æŸï¼Œæ™‹æœç»Ÿä¸€å¤©ä¸‹ï¼");
                            this.returnToCharacterSelection();
                        }, 3000);
                    }
                }, 30000); // 30ç§’ = 1å¹´
            }

            // æ›´æ–°å¹´ä»½æ˜¾ç¤º
            updateYearDisplay() {
                document.getElementById('yearDisplay').textContent = `${this.character} | å¹´ä»½: ${this.currentYear}å¹´`;
            }

            // è§¦å‘å†å²äº‹ä»¶
            triggerHistoricalEvent(event) {
                const result = event.effect(this);
                
                document.getElementById('eventTitle').textContent = `${this.currentYear}å¹´ - ${event.title}`;
                document.getElementById('eventMessage').textContent = `${event.message} ${result}`;
                document.getElementById('eventModal').style.display = 'flex';
                
                this.updateDisplay();
            }

            // æ£€æŸ¥æ˜¯å¦è§¦å‘éšæœºäº‹ä»¶
            checkForRandomEvent() {
                const now = Date.now();
                // è‡³å°‘5åˆ†é’Ÿæ‰ä¼šè§¦å‘ä¸€æ¬¡äº‹ä»¶
                if (now - this.lastEventTime < 300000) return;
                
                // è®¡ç®—æ€»æ¦‚ç‡
                const totalProbability = RANDOM_EVENTS.reduce((sum, event) => sum + event.probability, 0);
                const roll = Math.random() * totalProbability;
                
                let cumulativeProbability = 0;
                for (const event of RANDOM_EVENTS) {
                    cumulativeProbability += event.probability;
                    if (roll <= cumulativeProbability) {
                        this.triggerEvent(event);
                        this.lastEventTime = now;
                        break;
                    }
                }
            }

            // è§¦å‘éšæœºäº‹ä»¶
            triggerEvent(event) {
                const result = event.effect(this);
                
                document.getElementById('eventTitle').textContent = event.title;
                document.getElementById('eventMessage').textContent = `${event.message} ${result}`;
                document.getElementById('eventModal').style.display = 'flex';
                
                this.updateDisplay();
            }

            // å…³é—­äº‹ä»¶çª—å£
            closeEvent() {
                document.getElementById('eventModal').style.display = 'none';
            }

            // æ˜¾ç¤ºåŸæ± å†å²
            showCityHistory(cityName) {
                document.getElementById('cityHistoryTitle').textContent = `${cityName}å†å²`;
                document.getElementById('cityHistoryMessage').textContent = CITY_HISTORIES[cityName];
                document.getElementById('cityHistoryModal').style.display = 'flex';
            }

            // å…³é—­åŸæ± å†å²
            closeCityHistory() {
                document.getElementById('cityHistoryModal').style.display = 'none';
                this.resetAttack(); // å…³é—­å†å²çª—å£åé‡ç½®æ”»å‡»çŠ¶æ€
            }

            // æ˜¾ç¤ºèƒœåˆ©åŠ¨ç”»
            showVictoryAnimation() {
                const victoryContent = document.getElementById('victoryContent');
                victoryContent.innerHTML = `
                    <h2 style="color: #8B0000; text-align: center; margin-bottom: 20px;">${this.character}ç»Ÿä¸€å¤©ä¸‹</h2>
                    <p style="font-size: 1.2rem; line-height: 1.6; white-space: pre-line;">${CHARACTER_HISTORIES[this.character]}</p>
                `;
                
                document.getElementById('victoryAnimation').style.display = 'flex';
                
                // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                setTimeout(() => {
                    victoryContent.style.opacity = '1';
                    victoryContent.style.transform = 'translateY(0)';
                }, 100);
                
                // 5ç§’åè¿”å›è§’è‰²é€‰æ‹©
                setTimeout(() => {
                    this.returnToCharacterSelection();
                }, 10000);
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºèµ„æºè·å–æŒ‰é’®
            checkResourceButton() {
                const btn = document.getElementById('earnResourceBtn');
                // å½“èµ„é‡‘å’Œç²®è‰éƒ½ä½äº1000æ—¶æ˜¾ç¤ºæŒ‰é’®
                if (this.state.gold < 1000 && this.state.food < 1000) {
                    btn.style.display = 'block';
                } else {
                    btn.style.display = 'none';
                }
            }

            // æ‰“ä¹±é—®é¢˜é€‰é¡¹é¡ºåº
            shuffleQuestion(question) {
                const options = [...question.o];
                const correctAnswer = options[question.a];
                
                // éšæœºæ‰“ä¹±é€‰é¡¹
                for (let i = options.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [options[i], options[j]] = [options[j], options[i]];
                }
                
                return {
                    q: question.q,
                    o: options,
                    a: options.indexOf(correctAnswer),
                    hint: question.hint
                };
            }

            initMap() {
                const map = document.getElementById('map');
                map.innerHTML = '';
                CITIES.forEach(city => {
                    const node = document.createElement('div');
                    node.className = 'city-node';
                    node.style.left = `${city.x}%`;
                    node.style.top = `${city.y}%`;
                    node.textContent = city.name;
                    node.title = `${city.name} (${city.defender}é©»å®ˆ, å…µåŠ›: ${city.troops})`;
                    node.onclick = () => this.attackCity(city);
                    if (this.state.cities.includes(city.name)) {
                        node.classList.add('city-node-owned');
                    }
                    map.appendChild(node);
                });
            }

            attackCity(city) {
                if (this.isAnswering) return; // é˜²æ­¢é‡å¤ç‚¹å‡»
                
                if (this.state.cities.includes(city.name)) {
                    alert('è¯¥åœ°ç›˜å·²å é¢†');
                    return;
                }
                if (this.state.troops <= 0) {
                    alert('å…µåŠ›ä¸è¶³ï¼');
                    return;
                }
                if (this.state.food < 5000) {
                    alert('ç²®è‰ä¸è¶³ï¼æ¯æ¬¡æ”»åŸéœ€è¦5000ç²®è‰');
                    return;
                }
                
                this.isAnswering = true; // æ ‡è®°ä¸ºæ­£åœ¨ç­”é¢˜çŠ¶æ€
                
                // æ ¹æ®æ•Œæ–¹å…µåŠ›è°ƒæ•´éœ€è¦ç­”å¯¹çš„é¢˜ç›®æ•°é‡
                if (city.troops > this.state.troops) {
                    this.requiredAnswers = 3;
                    alert(`è­¦å‘Šï¼${city.defender}é©»å®ˆçš„${city.name}å…µåŠ›(${city.troops})è¶…è¿‡ä½ çš„å…µåŠ›(${this.state.troops})ï¼Œéœ€è¦ç­”å¯¹3é¢˜æ‰èƒ½æ”»ä¸‹ï¼`);
                } else {
                    this.requiredAnswers = 2;
                }
                
                // æ¶ˆè€—ç²®è‰
                this.state.food -= 5000;
                this.updateDisplay();
                
                this.currentCity = city;
                this.correctAnswers = 0;
                document.getElementById('progressBox').style.display = 'block';
                document.getElementById('correctAnswers').textContent = this.correctAnswers;
                document.getElementById('requiredAnswers').textContent = this.requiredAnswers;
                document.getElementById('hintBox').style.display = 'none';
                
                // æ˜¾ç¤ºå®ˆå°†å¯¹è¯
                this.showGeneralDialogue(city.defender);
            }

            // æ˜¾ç¤ºæ­¦å°†å¯¹è¯
            showGeneralDialogue(generalName) {
                if (!GENERAL_DIALOGUES[generalName]) {
                    this.showQuestion();
                    return;
                }
                
                this.currentDialogue = GENERAL_DIALOGUES[generalName];
                this.dialogueIndex = 0;
                
                document.getElementById('dialogueTitle').textContent = `ä¸${generalName}å¯¹è¯`;
                document.getElementById('dialogueSpeaker').textContent = generalName;
                document.getElementById('dialogueMessage').textContent = this.currentDialogue[0].message;
                document.getElementById('dialogueNextBtn').textContent = 'ç»§ç»­';
                
                // è®¾ç½®æ­¦å°†å¤´åƒ
                const portrait = document.getElementById('dialoguePortrait');
                portrait.style.backgroundImage = `url('https://source.unsplash.com/random/80x80/?portrait,${generalName}')`;
                
                document.getElementById('dialogueModal').style.display = 'flex';
            }

            // ç»§ç»­å¯¹è¯
            nextDialogue() {
                this.dialogueIndex++;
                
                if (this.dialogueIndex < this.currentDialogue.length) {
                    // æ˜¾ç¤ºä¸‹ä¸€æ¡å¯¹è¯
                    document.getElementById('dialogueMessage').textContent = 
                        this.currentDialogue[this.dialogueIndex].message;
                } else {
                    // å¯¹è¯ç»“æŸï¼Œæ˜¾ç¤ºé—®é¢˜
                    document.getElementById('dialogueModal').style.display = 'none';
                    this.showQuestion();
                }
            }

            showQuestion() {
                const originalQuestion = QUESTIONS[Math.floor(Math.random() * QUESTIONS.length)];
                const question = this.shuffleQuestion(originalQuestion);
                
                this.currentQuestion = question;
                const box = document.getElementById('questionBox');
                box.innerHTML = `
                    <h3>æ”»æ‰“ ${this.currentCity.defender} é©»å®ˆçš„ ${this.currentCity.name} (æ¶ˆè€—5000ç²®è‰)</h3>
                    <p>${question.q}</p>
                    ${question.o.map((opt, i) => `
                        <button class="action-button" onclick="game.answer(${i}, ${question.a})">${opt}</button>
                    `).join('')}
                    ${this.state.items.freeAnswer > 0 ? 
                        `<button class="action-button" onclick="game.useFreeAnswer()" style="background-color: #4CAF50;">ä½¿ç”¨å…ç­”å¡ (å‰©ä½™${this.state.items.freeAnswer})</button>` : ''}
                `;
            }

            // æ–°å¢çš„é˜²å¾¡åŸæ± æ–¹æ³•
            defendCity(city) {
                this.isAnswering = true;
                this.currentCity = city;
                this.correctAnswers = 0;
                this.requiredAnswers = 2; // éœ€è¦ç­”å¯¹2é¢˜é˜²å®ˆæˆåŠŸ
                
                document.getElementById('questionBox').innerHTML = `
                    <h3>é˜²å®ˆ ${city.name} (éœ€è¦ç­”å¯¹${this.requiredAnswers}é¢˜)</h3>
                    <p>æ•Œå†›æ­£åœ¨æ”»æ‰“${city.name}ï¼Œè¯·å›ç­”é—®é¢˜é˜²å®ˆåŸæ± ï¼</p>
                `;
                
                document.getElementById('progressBox').style.display = 'block';
                document.getElementById('correctAnswers').textContent = this.correctAnswers;
                document.getElementById('requiredAnswers').textContent = this.requiredAnswers;
                document.getElementById('hintBox').style.display = 'none';
                
                this.showDefenseQuestion();
            }

            // æ–°å¢çš„æ˜¾ç¤ºé˜²å¾¡é—®é¢˜æ–¹æ³•
            showDefenseQuestion() {
                const originalQuestion = QUESTIONS[Math.floor(Math.random() * QUESTIONS.length)];
                const question = this.shuffleQuestion(originalQuestion);
                
                this.currentQuestion = question;
                const box = document.getElementById('questionBox');
                box.innerHTML += `
                    <p>${question.q}</p>
                    ${question.o.map((opt, i) => `
                        <button class="action-button" onclick="game.answerDefense(${i}, ${question.a})">${opt}</button>
                    `).join('')}
                    ${this.state.items.freeAnswer > 0 ? 
                        `<button class="action-button" onclick="game.useFreeAnswerDefense()" style="background-color: #4CAF50;">ä½¿ç”¨å…ç­”å¡ (å‰©ä½™${this.state.items.freeAnswer})</button>` : ''}
                `;
            }

            showHint() {
                if (!this.currentQuestion) {
                    alert('è¯·åœ¨æ”»åŸæ—¶ä½¿ç”¨æç¤ºï¼');
                    return;
                }
                
                document.getElementById('hintBox').style.display = 'block';
                document.getElementById('hintText').textContent = this.currentQuestion.hint;
            }

            answer(selected, correct) {
                if (!this.isAnswering) return; // é˜²æ­¢åœ¨éç­”é¢˜çŠ¶æ€ä¸‹å›ç­”é—®é¢˜
                
                const isCorrect = selected === correct;
                const selectedAnswer = this.currentQuestion.o[selected];
                const correctAnswer = this.currentQuestion.o[correct];
                
                // è®°å½•ç­”é¢˜å†å²
                this.stats.history.push({
                    question: this.currentQuestion.q,
                    selected: selectedAnswer,
                    correct: correctAnswer,
                    isCorrect: isCorrect
                });
                
                if (isCorrect) {
                    this.correctAnswers++;
                    this.stats.correct++;
                    this.stats.currentStreak++;
                    if (this.stats.currentStreak > this.stats.maxStreak) {
                        this.stats.maxStreak = this.stats.currentStreak;
                    }
                    document.getElementById('correctAnswers').textContent = this.correctAnswers;
                    document.getElementById('correctCount').textContent = this.stats.correct;
                    
                    if (this.correctAnswers >= this.requiredAnswers) {
                        let goldReward = 1000;
                        let troopsReward = 300;
                        
                        // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨åŒå€å¥–åŠ±å¡
                        if (this.state.items.doubleReward > 0) {
                            goldReward *= 2;
                            troopsReward *= 2;
                            this.state.items.doubleReward--;
                            alert('åŒå€å¥–åŠ±å¡ç”Ÿæ•ˆï¼è·å¾—åŒå€å¥–åŠ±');
                        }
                        
                        this.state.gold += goldReward;
                        this.state.troops += troopsReward;
                        this.state.cities.push(this.currentCity.name);
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰ç»“ç›Ÿï¼Œå¹¶æ›´æ–°æ”»å åŸæ± è®¡æ•°
                        if (this.state.alliance.active) {
                            this.state.alliance.conqueredSinceAlliance++;
                            // æ¯æ”»å 2åº§åŸæ± ï¼Œè·å¾—ç»“ç›Ÿå¥–åŠ±
                            if (this.state.alliance.conqueredSinceAlliance >= 2) {
                                const allianceBonusGold = 1500;
                                const allianceBonusTroops = 800;
                                this.state.gold += allianceBonusGold;
                                this.state.troops += allianceBonusTroops;
                                this.state.alliance.conqueredSinceAlliance = 0;
                                alert(`ç»“ç›Ÿå¥–åŠ±ï¼è·å¾—${allianceBonusGold}é‡‘å’Œ${allianceBonusTroops}å…µåŠ›`);
                            }
                        }
                        
                        // æ˜¾ç¤ºå¤„ç½®å®ˆå°†é€‰æ‹©
                        this.showExecutionOptions(this.currentCity.defender);
                    } else {
                        this.showQuestion();
                    }
                } else {
                    this.state.troops -= 500;
                    this.stats.wrong++;
                    this.stats.currentStreak = 0;
                    document.getElementById('wrongCount').textContent = this.stats.wrong;
                    alert(`å›ç­”é”™è¯¯ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯: ${correctAnswer}\næŸå¤±500å…µåŠ›`);
                    this.resetAttack();
                }
                this.updateDisplay();
                this.initMap();
                this.checkResourceButton();
            }

            // æ˜¾ç¤ºå¤„ç½®å®ˆå°†é€‰é¡¹
            showExecutionOptions(generalName) {
                document.getElementById('executionTitle').textContent = `å¤„ç½®${generalName}`;
                document.getElementById('executionMessage').textContent = `ä½ å·²æ”»ä¸‹${this.currentCity.name}ï¼Œå¦‚ä½•å¤„ç½®å®ˆå°†${generalName}ï¼Ÿ`;
                
                const optionsDiv = document.getElementById('executionOptions');
                optionsDiv.innerHTML = '';
                
                // æ ¹æ®è§’è‰²ä¸åŒæ˜¾ç¤ºä¸åŒé€‰é¡¹ï¼Œä½†éƒ½åŒ…å«"æ–©é¦–ç¤ºä¼—"é€‰é¡¹
                if (this.character === 'æ›¹æ“') {
                    // æ›¹æ“é€‰é¡¹ï¼šæ–©é¦–ã€æ”¶ç¼–ã€é‡Šæ”¾
                    optionsDiv.innerHTML = `
                        <button class="execution-option" onclick="game.executeGeneral('${generalName}', 'æ–©é¦–')">æ–©é¦–ç¤ºä¼—ï¼ˆå¨æ…‘+10ï¼Œå£°æœ›-5ï¼‰</button>
                        <button class="execution-option" onclick="game.executeGeneral('${generalName}', 'æ”¶ç¼–')">æ”¶ç¼–éº¾ä¸‹ï¼ˆå…µåŠ›+800ï¼Œå£°æœ›+5ï¼‰</button>
                        <button class="execution-option" onclick="game.executeGeneral('${generalName}', 'é‡Šæ”¾')">é‡Šæ”¾ï¼ˆå£°æœ›+10ï¼‰</button>
                    `;
                } else if (this.character === 'åˆ˜å¤‡') {
                    // åˆ˜å¤‡é€‰é¡¹ï¼šæ–©é¦–ã€åŠé™ã€é‡Šæ”¾
                    optionsDiv.innerHTML = `
                        <button class="execution-option" onclick="game.executeGeneral('${generalName}', 'æ–©é¦–')">æ–©é¦–ç¤ºä¼—ï¼ˆå¨æ…‘+10ï¼Œå£°æœ›-5ï¼‰</button>
                        <button class="execution-option" onclick="game.executeGeneral('${generalName}', 'åŠé™')">å¥½è¨€åŠé™ï¼ˆå£°æœ›+10ï¼Œ50%å‡ ç‡å…µåŠ›+500ï¼‰</button>
                        <button class="execution-option" onclick="game.executeGeneral('${generalName}', 'é‡Šæ”¾')">é‡Šæ”¾ï¼ˆå£°æœ›+15ï¼‰</button>
                    `;
                } else {
                    // å­™æƒé€‰é¡¹ï¼šæ–©é¦–ã€æ”¶ç¼–ã€æµæ”¾
                    optionsDiv.innerHTML = `
                        <button class="execution-option" onclick="game.executeGeneral('${generalName}', 'æ–©é¦–')">æ–©é¦–ç¤ºä¼—ï¼ˆå¨æ…‘+10ï¼Œå£°æœ›-5ï¼‰</button>
                        <button class="execution-option" onclick="game.executeGeneral('${generalName}', 'æ”¶ç¼–')">æ”¶ç¼–éº¾ä¸‹ï¼ˆå…µåŠ›+700ï¼Œå£°æœ›+5ï¼‰</button>
                        <button class="execution-option" onclick="game.executeGeneral('${generalName}', 'æµæ”¾')">æµæ”¾è¾¹ç–†ï¼ˆå¨æ…‘+5ï¼Œå£°æœ›-3ï¼‰</button>
                    `;
                }
                
                document.getElementById('executionModal').style.display = 'flex';
            }

            // å¤„ç½®å®ˆå°†
            executeGeneral(generalName, option) {
                let message = '';
                
                switch(option) {
                    case 'æ–©é¦–':
                        this.state.reputation = Math.max(0, this.state.reputation - 5);
                        message = `ä½ ä¸‹ä»¤å°†${generalName}æ–©é¦–ç¤ºä¼—ï¼Œå¨æ…‘åŠ›å¢åŠ ä½†å£°æœ›ä¸‹é™ï¼`;
                        break;
                    case 'æ”¶ç¼–':
                        if (this.character === 'æ›¹æ“') {
                            this.state.troops += 800;
                            this.state.reputation += 5;
                            message = `${generalName}è¢«ä½ çš„å¨åæ‰€æ…‘ï¼Œç‡éƒ¨å½’é¡ºï¼å…µåŠ›å¢åŠ 800ï¼Œå£°æœ›æå‡ã€‚`;
                        } else {
                            this.state.troops += 700;
                            this.state.reputation += 5;
                            message = `${generalName}é’¦ä½©ä½ çš„æ‰èƒ½ï¼Œæ„¿æ„æ•ˆåŠ›ï¼å…µåŠ›å¢åŠ 700ï¼Œå£°æœ›æå‡ã€‚`;
                        }
                        break;
                    case 'é‡Šæ”¾':
                        if (this.character === 'åˆ˜å¤‡') {
                            this.state.reputation += 15;
                            message = `ä½ é‡Šæ”¾äº†${generalName}ï¼Œå¤©ä¸‹äººç§°èµä½ çš„ä»ä¹‰ï¼å£°æœ›å¤§å¹…æå‡ã€‚`;
                        } else {
                            this.state.reputation += 10;
                            message = `ä½ é‡Šæ”¾äº†${generalName}ï¼Œè·å¾—äº†å®½åšå¾…äººçš„åå£°ï¼å£°æœ›æå‡ã€‚`;
                        }
                        break;
                    case 'åŠé™':
                        if (Math.random() < 0.5) {
                            this.state.troops += 500;
                            this.state.reputation += 10;
                            message = `${generalName}è¢«ä½ çš„è¯šæ„æ„ŸåŠ¨ï¼Œæ„¿æ„å½’é¡ºï¼å…µåŠ›å¢åŠ 500ï¼Œå£°æœ›æå‡ã€‚`;
                        } else {
                            this.state.reputation += 5;
                            message = `${generalName}æ‹’ç»æŠ•é™ï¼Œä½†æ„Ÿæ¿€ä½ çš„ä¸æ€ä¹‹æ©ï¼å£°æœ›ç•¥å¾®æå‡ã€‚`;
                        }
                        break;
                    case 'æµæ”¾':
                        this.state.reputation = Math.max(0, this.state.reputation - 3);
                        message = `ä½ å°†${generalName}æµæ”¾è¾¹ç–†ï¼Œå¨æ…‘åŠ›å¢åŠ ä½†å£°æœ›ç•¥æœ‰ä¸‹é™ã€‚`;
                        break;
                }
                
                // ç¡®ä¿å£°æœ›åœ¨0-100èŒƒå›´å†…
                this.state.reputation = Math.min(100, Math.max(0, this.state.reputation));
                
                alert(message);
                document.getElementById('executionModal').style.display = 'none';
                
                // æ˜¾ç¤ºåŸæ± å†å²
                this.showCityHistory(this.currentCity.name);
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»å é¢†æ‰€æœ‰åŸæ± 
                if (this.state.cities.length === CITIES.length) {
                    setTimeout(() => {
                        this.showVictoryAnimation();
                        clearInterval(this.eventCheckInterval); // æ¸¸æˆç»“æŸåœæ­¢æ£€æŸ¥äº‹ä»¶
                        if (this.agricultureInterval) {
                            clearInterval(this.agricultureInterval);
                        }
                    }, 500);
                }
                
                this.updateDisplay();
            }

            // æ–°å¢çš„é˜²å¾¡ç­”é¢˜æ–¹æ³•
            answerDefense(selected, correct) {
                const isCorrect = selected === correct;
                const selectedAnswer = this.currentQuestion.o[selected];
                const correctAnswer = this.currentQuestion.o[correct];
                
                // è®°å½•ç­”é¢˜å†å²
                this.stats.history.push({
                    question: this.currentQuestion.q,
                    selected: selectedAnswer,
                    correct: correctAnswer,
                    isCorrect: isCorrect
                });
                
                if (isCorrect) {
                    this.correctAnswers++;
                    this.stats.correct++;
                    this.stats.currentStreak++;
                    if (this.stats.currentStreak > this.stats.maxStreak) {
                        this.stats.maxStreak = this.stats.currentStreak;
                    }
                    document.getElementById('correctAnswers').textContent = this.correctAnswers;
                    document.getElementById('correctCount').textContent = this.stats.correct;
                    
                    if (this.correctAnswers >= this.requiredAnswers) {
                        // é˜²å®ˆæˆåŠŸ
                        alert(`é˜²å®ˆæˆåŠŸï¼${this.currentCity.name}ä»åœ¨ä½ æŒæ§ä¸­`);
                        this.resetAttack();
                    } else {
                        this.showDefenseQuestion();
                    }
                } else {
                    // é˜²å®ˆå¤±è´¥
                    const cityIndex = this.state.cities.indexOf(this.currentCity.name);
                    if (cityIndex !== -1) {
                        this.state.cities.splice(cityIndex, 1);
                    }
                    this.state.troops -= 500;
                    this.stats.wrong++;
                    this.stats.currentStreak = 0;
                    document.getElementById('wrongCount').textContent = this.stats.wrong;
                    alert(`å›ç­”é”™è¯¯ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯: ${correctAnswer}\né˜²å®ˆå¤±è´¥ï¼Œ${this.currentCity.name}è¢«æ•Œå†›æ”»å ï¼`);
                    this.resetAttack();
                }
                this.updateDisplay();
                this.initMap();
            }

            useFreeAnswer() {
                if (!this.isAnswering || this.state.items.freeAnswer <= 0) return;
                
                this.state.items.freeAnswer--;
                this.correctAnswers++;
                document.getElementById('correctAnswers').textContent = this.correctAnswers;
                alert('ä½¿ç”¨å…ç­”å¡æˆåŠŸï¼è‡ªåŠ¨ç­”å¯¹ä¸€é¢˜');
                
                if (this.correctAnswers >= this.requiredAnswers) {
                    this.state.gold += 1000;
                    this.state.troops += 300;
                    this.state.cities.push(this.currentCity.name);
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰ç»“ç›Ÿï¼Œå¹¶æ›´æ–°æ”»å åŸæ± è®¡æ•°
                    if (this.state.alliance.active) {
                        this.state.alliance.conqueredSinceAlliance++;
                        // æ¯æ”»å 2åº§åŸæ± ï¼Œè·å¾—ç»“ç›Ÿå¥–åŠ±
                        if (this.state.alliance.conqueredSinceAlliance >= 2) {
                            const allianceBonusGold = 1500;
                            const allianceBonusTroops = 800;
                            this.state.gold += allianceBonusGold;
                            this.state.troops += allianceBonusTroops;
                            this.state.alliance.conqueredSinceAlliance = 0;
                            alert(`ç»“ç›Ÿå¥–åŠ±ï¼è·å¾—${allianceBonusGold}é‡‘å’Œ${allianceBonusTroops}å…µåŠ›`);
                        }
                    }
                    
                    // æ˜¾ç¤ºå¤„ç½®å®ˆå°†é€‰æ‹©
                    this.showExecutionOptions(this.currentCity.defender);
                } else {
                    this.showQuestion();
                }
                
                this.updateDisplay();
                this.initMap();
                this.checkResourceButton();
            }

            // æ–°å¢çš„é˜²å¾¡ä¸­ä½¿ç”¨å…ç­”å¡æ–¹æ³•
            useFreeAnswerDefense() {
                if (this.state.items.freeAnswer <= 0) return;
                
                this.state.items.freeAnswer--;
                this.correctAnswers++;
                document.getElementById('correctAnswers').textContent = this.correctAnswers;
                alert('ä½¿ç”¨å…ç­”å¡æˆåŠŸï¼è‡ªåŠ¨ç­”å¯¹ä¸€é¢˜');
                
                if (this.correctAnswers >= this.requiredAnswers) {
                    // é˜²å®ˆæˆåŠŸ
                    alert(`é˜²å®ˆæˆåŠŸï¼${this.currentCity.name}ä»åœ¨ä½ æŒæ§ä¸­`);
                    this.resetAttack();
                } else {
                    this.showDefenseQuestion();
                }
                
                this.updateDisplay();
                this.initMap();
            }

            resetAttack() {
                this.isAnswering = false; // é‡ç½®ç­”é¢˜çŠ¶æ€
                this.currentCity = null;
                this.currentQuestion = null;
                this.correctAnswers = 0;
                this.requiredAnswers = 2;
                document.getElementById('questionBox').innerHTML = '<p>ç‚¹å‡»åœ°å›¾ä¸Šçš„åŸæ± å¼€å§‹æ”»åŸï¼</p>';
                document.getElementById('progressBox').style.display = 'none';
                document.getElementById('hintBox').style.display = 'none';
            }

            militaryReform() {
                if (this.state.gold >= 2000) {
                    this.state.gold -= 2000;
                    this.state.troops = Math.floor(this.state.troops * 1.2);
                    this.updateDisplay();
                    alert('å†›äº‹æ”¹é©æˆåŠŸï¼å…µåŠ›å¢åŠ 20%');
                    this.checkResourceButton();
                } else {
                    alert('èµ„é‡‘ä¸è¶³ï¼');
                }
            }

            agriculturalDevelopment() {
                if (this.state.gold >= 1500) {
                    this.state.gold -= 1500;
                    this.agricultureLevel++;
                    
                    // ä¿®æ”¹å†œä¸šå‘å±•æ•ˆæœï¼šæ¯0.5ç§’åŠ 10ç²®è‰ï¼Œæ¯å†œä¸šå‘å±•ä¸€æ¬¡å°±åœ¨åŸæœ¬å¢åŠ 10ç²®è‰çš„åŸºç¡€ä¸ŠåŠ 10ç²®è‰
                    const bonusPerHalfSecond = 10 + this.agricultureLevel * 10;
                    
                    // å¦‚æœå·²ç»æœ‰å®šæ—¶å™¨ï¼Œå…ˆæ¸…é™¤
                    if (this.agricultureInterval) {
                        clearInterval(this.agricultureInterval);
                    }
                    
                    // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼Œæ¯0.5ç§’å¢åŠ ç²®è‰
                    this.agricultureInterval = setInterval(() => {
                        this.state.food += bonusPerHalfSecond;
                        this.updateDisplay();
                    }, 500); // 0.5ç§’
                    
                    document.getElementById('agriLevel').textContent = this.agricultureLevel;
                    this.updateDisplay();
                    alert(`å†œä¸šå‘å±•æˆåŠŸï¼ç°åœ¨æ¯0.5ç§’è·å¾—${bonusPerHalfSecond}ç²®è‰`);
                    this.checkResourceButton();
                } else {
                    alert('èµ„é‡‘ä¸è¶³ï¼');
                }
            }

            openShop() {
                document.getElementById('shopModal').style.display = 'flex';
            }

            closeShop() {
                document.getElementById('shopModal').style.display = 'none';
            }

            buyItem(type) {
                let cost = 0;
                let success = false;
                
                switch(type) {
                    case 'troops':
                        cost = 3000;
                        if (this.state.gold >= cost) {
                            this.state.gold -= cost;
                            this.state.troops += 1000;
                            success = true;
                            alert('è´­ä¹°æˆåŠŸï¼å…µåŠ›å¢åŠ 1000');
                        }
                        break;
                    case 'food':
                        cost = 2000;
                        if (this.state.gold >= cost) {
                            this.state.gold -= cost;
                            this.state.food += 5000;
                            success = true;
                            alert('è´­ä¹°æˆåŠŸï¼ç²®è‰å¢åŠ 5000');
                        }
                        break;
                    case 'freeAnswer':
                        cost = 2500;
                        if (this.state.gold >= cost) {
                            this.state.gold -= cost;
                            this.state.items.freeAnswer++;
                            success = true;
                            alert('è´­ä¹°æˆåŠŸï¼è·å¾—1å¼ å…ç­”å¡');
                        }
                        break;
                    case 'doubleReward':
                        cost = 4000;
                        if (this.state.gold >= cost) {
                            this.state.gold -= cost;
                            this.state.items.doubleReward++;
                            success = true;
                            alert('è´­ä¹°æˆåŠŸï¼è·å¾—1å¼ åŒå€å¥–åŠ±å¡');
                        }
                        break;
                }
                
                if (success) {
                    this.updateDisplay();
                    this.checkResourceButton();
                } else {
                    alert('èµ„é‡‘ä¸è¶³ï¼');
                }
            }

            showStats() {
                const tableBody = document.getElementById('statsTableBody');
                tableBody.innerHTML = '';
                
                this.stats.history.forEach((record, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.question}</td>
                        <td>${record.selected}</td>
                        <td>${record.correct}</td>
                        <td style="color: ${record.isCorrect ? 'green' : 'red'}">${record.isCorrect ? 'âœ…' : 'âŒ'}</td>
                    `;
                    tableBody.appendChild(row);
                });
                
                const total = this.stats.correct + this.stats.wrong;
                const accuracy = total > 0 ? Math.round((this.stats.correct / total) * 100) : 0;
                
                document.getElementById('totalQuestions').textContent = total;
                document.getElementById('accuracyRate').textContent = accuracy;
                document.getElementById('maxStreak').textContent = this.stats.maxStreak;
                
                document.getElementById('statsModal').style.display = 'flex';
            }

            closeStats() {
                document.getElementById('statsModal').style.display = 'none';
            }

            // ç­”é¢˜è·å–èµ„æº
            earnResourcesByAnswering() {
                // æ˜¾ç¤ºèµ„æºè·å–æ¨¡æ€æ¡†
                document.getElementById('resourceModal').style.display = 'flex';
                this.resourceCorrectAnswers = 0;
                this.resourceRequiredAnswers = 3;
                document.getElementById('resourceProgressBox').style.display = 'block';
                document.getElementById('resourceCorrectAnswers').textContent = this.resourceCorrectAnswers;
                document.getElementById('resourceRequiredAnswers').textContent = this.resourceRequiredAnswers;
                
                this.showResourceQuestion();
            }

            // æ˜¾ç¤ºèµ„æºè·å–é—®é¢˜
            showResourceQuestion() {
                const originalQuestion = QUESTIONS[Math.floor(Math.random() * QUESTIONS.length)];
                const question = this.shuffleQuestion(originalQuestion);
                
                this.resourceQuestion = question;
                const box = document.getElementById('resourceQuestionBox');
                box.innerHTML = `
                    <h3>ç­”é¢˜è·å–èµ„æº (ç­”å¯¹${this.resourceRequiredAnswers}é¢˜å¯è·å¾—å¥–åŠ±)</h3>
                    <p>${question.q}</p>
                    ${question.o.map((opt, i) => `
                        <button class="action-button" onclick="game.answerResourceQuestion(${i}, ${question.a})">${opt}</button>
                    `).join('')}
                `;
            }

            // å›ç­”èµ„æºè·å–é—®é¢˜
            answerResourceQuestion(selected, correct) {
                const isCorrect = selected === correct;
                const selectedAnswer = this.resourceQuestion.o[selected];
                const correctAnswer = this.resourceQuestion.o[correct];
                
                if (isCorrect) {
                    this.resourceCorrectAnswers++;
                    document.getElementById('resourceCorrectAnswers').textContent = this.resourceCorrectAnswers;
                    
                    if (this.resourceCorrectAnswers >= this.resourceRequiredAnswers) {
                        // å¥–åŠ±èµ„æº
                        const goldReward = 2000;
                        const foodReward = 3000;
                        this.state.gold += goldReward;
                        this.state.food += foodReward;
                        
                        alert(`ç­”é¢˜æˆåŠŸï¼è·å¾—${goldReward}é‡‘å’Œ${foodReward}ç²®è‰`);
                        this.closeResourceModal();
                        this.updateDisplay();
                        this.checkResourceButton();
                    } else {
                        this.showResourceQuestion();
                    }
                } else {
                    alert(`å›ç­”é”™è¯¯ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯: ${correctAnswer}`);
                    this.closeResourceModal();
                }
            }

            // å…³é—­èµ„æºè·å–æ¨¡æ€æ¡†
            closeResourceModal() {
                document.getElementById('resourceModal').style.display = 'none';
                this.resourceQuestion = null;
            }

            // å¼€å§‹ç»“ç›Ÿæµç¨‹
            startAlliance() {
                if (this.allianceCooldown) {
                    alert('ç»“ç›Ÿå¤±è´¥åéœ€è¦ç­‰å¾…15ç§’æ‰èƒ½å†æ¬¡å°è¯•ç»“ç›Ÿï¼');
                    return;
                }
                
                if (this.state.alliance.active) {
                    alert(`ä½ å·²ç»ä¸${this.state.alliance.city}ç»“ç›Ÿï¼`);
                    return;
                }
                
                // è·å–æœªè¢«å é¢†çš„åŸæ± åˆ—è¡¨
                const unoccupiedCities = CITIES.filter(city => !this.state.cities.includes(city.name));
                
                if (unoccupiedCities.length === 0) {
                    alert('æ²¡æœ‰å¯ç»“ç›Ÿçš„åŸæ± äº†ï¼');
                    return;
                }
                
                // æ˜¾ç¤ºç»“ç›Ÿæ¨¡æ€æ¡†
                document.getElementById('allianceModal').style.display = 'flex';
                
                // å¡«å……åŸæ± åˆ—è¡¨
                const cityList = document.getElementById('allianceCityList');
                cityList.innerHTML = '';
                
                unoccupiedCities.forEach(city => {
                    const cityOption = document.createElement('div');
                    cityOption.className = 'city-option';
                    cityOption.innerHTML = `
                        <input type="radio" name="allianceCity" id="city_${city.name}" value="${city.name}">
                        <label for="city_${city.name}">${city.name} (${city.defender}é©»å®ˆ)</label>
                    `;
                    cityList.appendChild(cityOption);
                });
                
                // è®¾ç½®ç¬¬ä¸€ä¸ªé€‰é¡¹ä¸ºé»˜è®¤é€‰ä¸­
                if (unoccupiedCities.length > 0) {
                    document.getElementById(`city_${unoccupiedCities[0].name}`).checked = true;
                }
                
                // è®¾ç½®ç¡®è®¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                document.getElementById('confirmAllianceBtn').onclick = () => this.confirmAlliance();
            }

            // ç¡®è®¤ç»“ç›Ÿ
            confirmAlliance() {
                const selectedCity = document.querySelector('input[name="allianceCity"]:checked');
                
                if (!selectedCity) {
                    alert('è¯·é€‰æ‹©ä¸€ä¸ªåŸæ± è¿›è¡Œç»“ç›Ÿï¼');
                    return;
                }
                
                const cityName = selectedCity.value;
                
                // 50%å‡ ç‡æˆåŠŸ
                const success = Math.random() < 0.5;
                
                if (success) {
                    // ç»“ç›ŸæˆåŠŸ
                    this.state.alliance = {
                        active: true,
                        city: cityName,
                        conqueredSinceAlliance: 0
                    };
                    
                    // æ˜¾ç¤ºç»“ç›ŸçŠ¶æ€å’ŒèƒŒå›æŒ‰é’®ï¼Œéšè—ç»“ç›ŸæŒ‰é’®
                    document.getElementById('allianceStatus').style.display = 'block';
                    document.getElementById('alliedCity').textContent = cityName;
                    document.getElementById('betrayBtn').style.display = 'block';
                    document.getElementById('allianceBtn').style.display = 'none';
                    
                    // è·å¾—åˆå§‹ç»“ç›Ÿå¥–åŠ±
                    const initialGoldBonus = 1000;
                    const initialTroopsBonus = 500;
                    this.state.gold += initialGoldBonus;
                    this.state.troops += initialTroopsBonus;
                    
                    alert(`ä¸${cityName}ç»“ç›ŸæˆåŠŸï¼è·å¾—åˆå§‹å¥–åŠ±${initialGoldBonus}é‡‘å’Œ${initialTroopsBonus}å…µåŠ›ã€‚æ¯æ”»å 2åº§åŸæ± å¯è·å¾—é¢å¤–å¥–åŠ±ã€‚`);
                } else {
                    // ç»“ç›Ÿå¤±è´¥
                    this.state.food = Math.max(0, this.state.food - 100);
                    alert(`ä¸${cityName}ç»“ç›Ÿå¤±è´¥ï¼æŸå¤±100ç²®è‰ã€‚15ç§’åæ‰èƒ½å†æ¬¡å°è¯•ç»“ç›Ÿã€‚`);
                    
                    // è®¾ç½®15ç§’å†·å´æ—¶é—´
                    this.allianceCooldown = true;
                    const allianceBtn = document.getElementById('allianceBtn');
                    allianceBtn.classList.add('disabled');
                    
                    // è®¾ç½®å†·å´è®¡æ—¶å™¨
                    this.allianceCooldownTimeout = setTimeout(() => {
                        this.allianceCooldown = false;
                        allianceBtn.classList.remove('disabled');
                    }, 15000);
                }
                
                this.closeAllianceModal();
                this.updateDisplay();
            }

            // èƒŒå›ç»“ç›Ÿæ–¹æ³•
            betrayAlliance() {
                if (!this.state.alliance.active) {
                    alert('å½“å‰æ²¡æœ‰ç»“ç›Ÿå…³ç³»ï¼');
                    return;
                }
                
                const confirmBetray = confirm(`ç¡®å®šè¦èƒŒå›ä¸${this.state.alliance.city}çš„ç»“ç›Ÿå—ï¼ŸèƒŒå›å15ç§’å†…æ— æ³•å†æ¬¡ç»“ç›Ÿï¼`);
                if (confirmBetray) {
                    const cityName = this.state.alliance.city;
                    
                    // èƒŒå›æƒ©ç½šï¼šæŸå¤±éƒ¨åˆ†èµ„æº
                    const goldLoss = Math.floor(this.state.gold * 0.1); // æŸå¤±10%èµ„é‡‘
                    const foodLoss = Math.floor(this.state.food * 0.1); // æŸå¤±10%ç²®è‰
                    this.state.gold = Math.max(0, this.state.gold - goldLoss);
                    this.state.food = Math.max(0, this.state.food - foodLoss);
                    
                    // é‡ç½®ç»“ç›ŸçŠ¶æ€
                    this.state.alliance = {
                        active: false,
                        city: null,
                        conqueredSinceAlliance: 0
                    };
                    
                    // éšè—ç»“ç›ŸçŠ¶æ€å’ŒèƒŒå›æŒ‰é’®ï¼Œæ˜¾ç¤ºç»“ç›ŸæŒ‰é’®
                    document.getElementById('allianceStatus').style.display = 'none';
                    document.getElementById('betrayBtn').style.display = 'none';
                    document.getElementById('allianceBtn').style.display = 'block';
                    
                    // è®¾ç½®15ç§’å†·å´æ—¶é—´
                    this.allianceCooldown = true;
                    const allianceBtn = document.getElementById('allianceBtn');
                    allianceBtn.classList.add('disabled');
                    
                    // è®¾ç½®å†·å´è®¡æ—¶å™¨
                    this.allianceCooldownTimeout = setTimeout(() => {
                        this.allianceCooldown = false;
                        allianceBtn.classList.remove('disabled');
                    }, 15000);
                    
                    alert(`ä½ èƒŒå›äº†ä¸${cityName}çš„ç»“ç›Ÿï¼æŸå¤±äº†${goldLoss}é‡‘å’Œ${foodLoss}ç²®è‰ã€‚15ç§’åæ‰èƒ½å†æ¬¡ç»“ç›Ÿã€‚`);
                    this.updateDisplay();
                }
            }

            // å…³é—­ç»“ç›Ÿæ¨¡æ€æ¡†
            closeAllianceModal() {
                document.getElementById('allianceModal').style.display = 'none';
            }

            returnToCharacterSelection() {
                // æ¸…é™¤å¹´ä»½è®¡æ—¶å™¨
                clearInterval(this.yearInterval);
                document.getElementById('yearDisplay').style.display = 'none';
                
                // æ¸…é™¤ç»“ç›Ÿå†·å´è®¡æ—¶å™¨
                if (this.allianceCooldownTimeout) {
                    clearTimeout(this.allianceCooldownTimeout);
                }
                
                // æ ‡è®°å½“å‰è§’è‰²ä¸ºå·²é€‰
                selectedCharacters.add(this.character);
                
                // éšè—æ¸¸æˆç•Œé¢å’Œèƒœåˆ©åŠ¨ç”»
                document.getElementById('gameContainer').style.display = 'none';
                document.getElementById('victoryAnimation').style.display = 'none';
                
                // æ˜¾ç¤ºè§’è‰²é€‰æ‹©ç•Œé¢
                document.getElementById('characterSelection').style.display = 'flex';
                
                // æ›´æ–°è§’è‰²é€‰æ‹©æç¤º
                const prompt = document.getElementById('selectionPrompt');
                prompt.textContent = selectedCharacters.size === 3 ? 
                    'æ‰€æœ‰è§’è‰²éƒ½å·²é€‰æ‹©è¿‡ï¼æ¸¸æˆå°†é‡æ–°å¼€å§‹' : 
                    'è¯·é€‰æ‹©ä¸€ä½ä¸»å…¬å¼€å§‹æ¸¸æˆ';
                
                // ç¦ç”¨å·²é€‰è§’è‰²
                document.querySelectorAll('.character-card').forEach(card => {
                    const character = card.id.replace('Card', '');
                    if (selectedCharacters.has(character)) {
                        card.classList.add('disabled');
                        card.onclick = null;
                    }
                });
                
                // åœæ­¢äº‹ä»¶æ£€æŸ¥å’Œå†œä¸šå‘å±•å®šæ—¶å™¨
                clearInterval(this.eventCheckInterval);
                if (this.agricultureInterval) {
                    clearInterval(this.agricultureInterval);
                }
                
                // é‡ç½®èƒŒå›æŒ‰é’®çŠ¶æ€
                document.getElementById('betrayBtn').style.display = 'none';
                document.getElementById('allianceBtn').style.display = 'block';
                
                // å¦‚æœæ‰€æœ‰è§’è‰²éƒ½å·²é€‰æ‹©è¿‡ï¼Œæ¸…ç©ºè®°å½•
                if (selectedCharacters.size === 3) {
                    setTimeout(() => {
                        selectedCharacters.clear();
                        document.querySelectorAll('.character-card').forEach(card => {
                            card.classList.remove('disabled');
                            const character = card.id.replace('Card', '');
                            card.onclick = () => selectCharacter(character);
                        });
                        prompt.textContent = 'è¯·é€‰æ‹©ä¸€ä½ä¸»å…¬å¼€å§‹æ¸¸æˆ';
                    }, 3000);
                }
            }

            updateDisplay() {
                document.getElementById('gold').textContent = this.state.gold;
                document.getElementById('food').textContent = this.state.food;
                document.getElementById('troops').textContent = this.state.troops;
                document.getElementById('citiesCount').textContent = this.state.cities.length;
                document.getElementById('correctCount').textContent = this.stats.correct;
                document.getElementById('wrongCount').textContent = this.stats.wrong;
                document.getElementById('agriLevel').textContent = this.agricultureLevel;
                document.getElementById('reputationValue').textContent = this.state.reputation;
            }
        }

        // å…¨å±€æ¸¸æˆå®ä¾‹
        let game;

        function startGame() {
            document.getElementById('coverScreen').style.display = 'none';
            document.getElementById('characterSelection').style.display = 'flex';
        }

        function selectCharacter(character) {
            if (selectedCharacters.has(character)) {
                alert('è¯¥è§’è‰²å·²è¢«é€‰æ‹©ï¼Œè¯·é€‰æ‹©å…¶ä»–ä¸»å…¬ï¼');
                return;
            }
            
            document.getElementById('characterSelection').style.display = 'none';
            game = new ThreeKingdomsGame(character);
            document.getElementById('gameContainer').style.display = 'grid';
        }

        function returnToCharacterSelection() {
            if (confirm('ç¡®å®šè¦è¿”å›è§’è‰²é€‰æ‹©ç•Œé¢å—ï¼Ÿå½“å‰æ¸¸æˆè¿›åº¦å°†ä¸¢å¤±ã€‚')) {
                if (game) {
                    game.returnToCharacterSelection();
                } else {
                    document.getElementById('gameContainer').style.display = 'none';
                    document.getElementById('characterSelection').style.display = 'flex';
                }
            }
        }
    </script>
</body>
</html>